<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–®–∏–Ω–æ–¶–µ–Ω—Ç—Ä ‚Äî –ë/–í —à–∏–Ω–∏</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        :root { --bg: #0a0c10; --panel: #14171c; --olive: #8fbc55; --text: #e5e7eb; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding-top: 130px; font-size: 14px;}
        
        .sticky-header { position: fixed; top: 0; left: 0; width: 100%; background: rgba(10, 12, 16, 0.95); z-index: 100; border-bottom: 1px solid #333; backdrop-filter: blur(8px); padding-bottom: 10px; }
        .header-content { padding: 10px 15px; max-width: 900px; margin: auto; display: flex; justify-content: space-between; align-items: center;}
        .logo { color: var(--olive); font-size: 22px; font-weight: 900; letter-spacing: 1px;}
        .search-box { width: calc(100% - 30px); margin: 0 15px; padding: 14px; border-radius: 10px; background: #000; color: #fff; border: 1px solid var(--olive); outline: none; box-sizing: border-box; font-size: 15px;}
        
        #admin-btn { display: none; background: #222; color: var(--olive); border: 1px solid var(--olive); padding: 8px 15px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 12px;}
        
        .nav-scroll { overflow-x: auto; white-space: nowrap; padding: 10px 15px 0; }
        .cat-btn { background: var(--panel); color: #aaa; border: 1px solid #333; padding: 8px 18px; border-radius: 20px; margin-right: 5px; font-size: 14px; cursor: pointer; font-weight: 500;}
        .cat-btn.active { background: var(--olive); color: #000; font-weight: bold; border-color: var(--olive); }
        
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px; max-width: 900px; margin: auto; }
        @media (min-width: 600px) { .grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); } }
        
        /* –í–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è –∫–∞—Ä—Ç–æ–∫ —Ç–∞ –∫–Ω–æ–ø–æ–∫ –ø–æ –Ω–∏–∑—É */
        .card { background: var(--panel); border-radius: 16px; border: 1px solid #2a2e35; padding: 12px; display: flex; flex-direction: column; position: relative; height: 100%; box-sizing: border-box;}
        .badge { position: absolute; top: 20px; right: 20px; background: var(--olive); color: #000; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; z-index: 10;}
        
        .photos { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 12px; }
        .main-p { grid-column: span 3; height: 160px; background: #000; border-radius: 10px; overflow: hidden; cursor: pointer; border: 1px solid #222;}
        .sub-p { height: 70px; background: #000; border-radius: 6px; overflow: hidden; cursor: pointer; border: 1px solid #222;}
        img { width: 100%; height: 100%; object-fit: cover; }
        
        /* –§—ñ–∫—Å–æ–≤–∞–Ω–∞ –≤–∏—Å–æ—Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
        .title { font-weight: 800; font-size: 14px; color: #fff; line-height: 1.3; margin-bottom: 8px; min-height: 55px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .price { color: var(--olive); font-size: 20px; font-weight: 900; margin-bottom: 12px; }
        
        /* –û–ø–∏—Å –∑–∞–π–º–∞—î –≤–µ—Å—å –≤—ñ–ª—å–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä, –≤—ñ–¥—à—Ç–æ–≤—Ö—É—é—á–∏ –∫–Ω–æ–ø–∫—É */
        .desc-box { background: #0f1114; padding: 12px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #222; font-size: 13px; color: #bbb; line-height: 1.5; flex-grow: 1;}
        .desc-text { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .desc-text.open { -webkit-line-clamp: unset; }
        .expand { color: var(--olive); font-weight: bold; font-size: 11px; text-transform: uppercase; cursor: pointer; text-align: center; margin-top: 8px; display: block; }
        
        .btn-buy { background: linear-gradient(180deg, #556b2f 0%, #3e4e22 100%); color: #fff; padding: 14px; border: none; border-radius: 10px; font-weight: bold; box-shadow: 0 4px 0 #283315; cursor: pointer; width: 100%; font-size: 15px; margin-top: auto;}
        .btn-buy:active { transform: translateY(2px); box-shadow: none; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 1000; justify-content: center; align-items: center; touch-action: none;}
        .modal-img { max-width: 95%; max-height: 80%; border-radius: 10px; transition: 0.3s; }
        .close { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 35px; cursor: pointer; z-index: 1001;}
        .nav-arr { position: absolute; top: 50%; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; padding: 20px; transform: translateY(-50%); z-index: 1001;}
        .prev { left: 0; } .next { right: 0; }
        .gal-dots { position: absolute; bottom: 30px; display: flex; gap: 8px; }
        .dot { width: 10px; height: 10px; background: #555; border-radius: 50%; }
        .dot.act { background: var(--olive); }

        .order-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;}
        .order-box { background: var(--panel); padding: 25px; border-radius: 16px; width: 100%; max-width: 400px; border: 1px solid var(--olive); box-shadow: 0 10px 30px rgba(0,0,0,0.8);}
        .order-box input, .order-box select { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 8px; background: #000; color: #fff; border: 1px solid #333; box-sizing: border-box; font-size: 15px;}
        
        #np-fields { display: block; }
        
        .empty-state { grid-column: span 2; text-align: center; padding: 40px 20px; color: #888; background: var(--panel); border-radius: 16px; border: 1px dashed #444;}
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="header-content">
        <div class="logo">TYRE SHOP</div>
        <a href="dashboard.html" id="admin-btn">üîë –í –ö–∞–±—ñ–Ω–µ—Ç</a>
    </div>
    <input type="text" id="search" class="search-box" placeholder="üîç –ü–æ—à—É–∫: —Ä–æ–∑–º—ñ—Ä, –±—Ä–µ–Ω–¥, —Å–µ–∑–æ–Ω..." oninput="filter()">
    <div class="nav-scroll">
        <button class="cat-btn active" onclick="setCat('–í—Å–µ', this)">–í—Å—ñ</button>
        <button class="cat-btn" onclick="setCat('R14', this)">R14</button>
        <button class="cat-btn" onclick="setCat('R15', this)">R15</button>
        <button class="cat-btn" onclick="setCat('R16', this)">R16</button>
        <button class="cat-btn" onclick="setCat('R17', this)">R17</button>
        <button class="cat-btn" onclick="setCat('R18', this)">R18</button>
    </div>
</div>

<div class="grid" id="grid"></div>

<div class="modal" id="gallery">
    <span class="close" onclick="closeGal()">√ó</span>
    <span class="nav-arr prev" onclick="navGal(-1)">‚ùÆ</span>
    <img class="modal-img" id="gal-img">
    <span class="nav-arr next" onclick="navGal(1)">‚ùØ</span>
    <div class="gal-dots" id="gal-dots"></div>
</div>

<div class="order-modal" id="orderModal">
    <div class="order-box">
        <h3 style="color:var(--olive); margin-top:0; text-align:center;">–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
        <div id="order-item-name" style="margin-bottom:20px; font-size:15px; font-weight:bold; color:#fff; text-align:center;"></div>
        
        <input type="text" id="c-name" placeholder="–Ü–º'—è —Ç–∞ –ü—Ä—ñ–∑–≤–∏—â–µ" required>
        <input type="tel" id="c-phone" placeholder="–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω" required>
        
        <select id="c-delivery" onchange="toggleDelivery()">
            <option value="–ù–æ–≤–∞ –ü–æ—à—Ç–∞">üöö –ù–æ–≤–∞ –ü–æ—à—Ç–∞</option>
            <option value="–°–∞–º–æ–≤–∏–≤—ñ–∑">üè¨ –°–∞–º–æ–≤–∏–≤—ñ–∑</option>
        </select>
        
        <div id="np-fields">
            <input type="text" id="c-city" placeholder="–ú—ñ—Å—Ç–æ / –ù–∞—Å–µ–ª–µ–Ω–∏–π –ø—É–Ω–∫—Ç">
            <input type="text" id="c-branch" placeholder="–ù–æ–º–µ—Ä –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è (–Ω–∞–ø—Ä. 15)">
        </div>

        <select id="c-payment">
            <option value="–ù–∞–∫–ª–∞–¥–µ–Ω–∏–π –ø–ª–∞—Ç—ñ–∂">üíµ –ü—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ (–ù–∞–∫–ª–∞–¥–µ–Ω–∏–π)</option>
            <option value="–ù–∞ –∫–∞—Ä—Ç–∫—É">üí≥ –ü–µ—Ä–µ–∫–∞–∑ –Ω–∞ –∫–∞—Ä—Ç–∫—É</option>
        </select>
        
        <button class="btn-buy" onclick="submitOrder()">–ü–Ü–î–¢–í–ï–†–î–ò–¢–ò –ó–ê–ú–û–í–õ–ï–ù–ù–Ø</button>
        <button class="btn-buy" style="background:transparent; border:1px solid #555; box-shadow:none; margin-top:10px; color:#aaa;" onclick="closeOrder()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
</div>

<script>
    const sb = supabase.createClient(CONFIG.SB_URL, CONFIG.SB_KEY);
    let items = []; let galImgs = []; let galIdx = 0; let activeOrderProduct = null;

    window.onload = () => {
        if(localStorage.getItem('is_admin') === 'true') document.getElementById('admin-btn').style.display = 'block';
        load();
    };

    async function load() {
        const { data } = await sb.from('products').select('*').eq('status', '–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ').order('created_at', { ascending: false });
        if(data) { items = data; render(items); }
    }

    function render(list) {
        const g = document.getElementById('grid'); g.innerHTML = '';
        if(list.length === 0) return g.innerHTML = `<div class="empty-state"><h3>üòï –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</h3><p>–ó–∞—Ä–∞–∑ —Ç–∞–∫–∏—Ö —à–∏–Ω –Ω–µ–º–∞—î, –∞–ª–µ –∞—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è —â–æ–¥–Ω—è.</p></div>`;

        list.forEach(p => {
            const imgs = [p.image_url_1, p.image_url_2, p.image_url_3, p.image_url_4].filter(Boolean);
            const imgJson = JSON.stringify(imgs).replace(/"/g, '&quot;');
            
            const badgeText = p.tread_depth || '';
            const badge = badgeText.includes('–Ω–æ–≤–∏') || badgeText.includes('8 –º–º') ? '<div class="badge">üî• –°—Ç–∞–Ω –Ω–æ–≤–æ—ó</div>' : '';
            
            let descHtml = '';
            if (p.specs || p.benefits || p.tread_depth) {
                descHtml = (p.tread_depth ? `<span style="color:var(--olive)"><b>–ó–Ω–æ—Å / –°—Ç–∞–Ω:</b></span> ${p.tread_depth}<br><br>` : '') +
                           (p.specs ? `<span style="color:var(--olive)"><b>–¢–µ—Ö. —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:</b></span> ${p.specs}<br><br>` : '') + 
                           (p.benefits ? `<span style="color:var(--olive)"><b>–í–∏–≥–æ–¥–∞ —Ç–∞ –ø–µ—Ä–µ–≤–∞–≥–∏:</b></span> ${p.benefits}` : '');
            } else {
                descHtml = p.description || '';
            }

            g.innerHTML += `
                <div class="card">
                    ${badge}
                    <div class="photos">
                        <div class="main-p" onclick="openGal('${imgJson}', 0)"><img src="${imgs[0]||''}"></div>
                        ${imgs[1] ? `<div class="sub-p" onclick="openGal('${imgJson}', 1)"><img src="${imgs[1]}"></div>` : ''}
                        ${imgs[2] ? `<div class="sub-p" onclick="openGal('${imgJson}', 2)"><img src="${imgs[2]}"></div>` : ''}
                        ${imgs[3] ? `<div class="sub-p" onclick="openGal('${imgJson}', 3)"><img src="${imgs[3]}"></div>` : ''}
                    </div>
                    <div class="title">${p.title}</div>
                    <div class="price">${p.price} –≥—Ä–Ω</div>
                    <div class="desc-box">
                        <div class="desc-text" id="desc-${p.id}">${descHtml}</div>
                        <span class="expand" onclick="tgDesc('desc-${p.id}', this)">–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ –¥–µ—Ç–∞–ª—ñ</span>
                    </div>
                    <button class="btn-buy" onclick="openOrder('${p.id}', '${p.title}', ${p.price})">–ó–ê–ú–û–í–ò–¢–ò</button>
                </div>`;
        });
    }

    /* –ì–∞–ª–µ—Ä–µ—è —Ç–∞ –°–≤–∞–π–ø–∏ */
    let touchStartX = 0;
    document.getElementById('gallery').addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
    document.getElementById('gallery').addEventListener('touchend', e => {
        const touchEndX = e.changedTouches[0].screenX;
        if(touchEndX < touchStartX - 50) navGal(1);
        if(touchEndX > touchStartX + 50) navGal(-1);
    });

    function openGal(imgsStr, idx) {
        galImgs = JSON.parse(imgsStr); galIdx = idx;
        updGalView(); document.getElementById('gallery').style.display = 'flex';
    }
    function navGal(dir) {
        galIdx += dir;
        if(galIdx < 0) galIdx = galImgs.length - 1;
        if(galIdx >= galImgs.length) galIdx = 0;
        updGalView();
    }
    function updGalView() {
        document.getElementById('gal-img').src = galImgs[galIdx];
        const dots = document.getElementById('gal-dots'); dots.innerHTML = '';
        galImgs.forEach((_, i) => dots.innerHTML += `<div class="dot ${i === galIdx ? 'act' : ''}"></div>`);
    }
    function closeGal() { document.getElementById('gallery').style.display = 'none'; }

    window.tgDesc = function(id, btn) {
        const el = document.getElementById(id);
        const open = el.classList.toggle('open');
        btn.innerText = open ? '–ó–≥–æ—Ä–Ω—É—Ç–∏' : '–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ –¥–µ—Ç–∞–ª—ñ';
    }

    function filter() {
        const v = document.getElementById('search').value.toLowerCase();
        render(items.filter(i => (`${i.title} ${i.specs} ${i.benefits} ${i.tread_depth}`).toLowerCase().includes(v)));
    }
    function setCat(c, b) {
        document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
        b.classList.add('active');
        render(c === '–í—Å–µ' ? items : items.filter(i => i.category === c));
    }

    /* –õ–æ–≥—ñ–∫–∞ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è */
    window.openOrder = function(id, title, price) {
        activeOrderProduct = { id, title, price };
        document.getElementById('order-item-name').innerText = `${title}\n${price} –≥—Ä–Ω`;
        document.getElementById('orderModal').style.display = 'flex';
    }
    
    window.closeOrder = function() { 
        document.getElementById('orderModal').style.display = 'none'; 
    }
    
    window.toggleDelivery = function() {
        const delType = document.getElementById('c-delivery').value;
        document.getElementById('np-fields').style.display = delType === '–ù–æ–≤–∞ –ü–æ—à—Ç–∞' ? 'block' : 'none';
    }
    
    window.submitOrder = async function() {
        const name = document.getElementById('c-name').value;
        const phone = document.getElementById('c-phone').value;
        const payment = document.getElementById('c-payment').value;
        let delivery = document.getElementById('c-delivery').value;
        
        if(!name || !phone) return alert("–í–≤–µ–¥—ñ—Ç—å –ü–Ü–ë —Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω!");

        if(delivery === '–ù–æ–≤–∞ –ü–æ—à—Ç–∞') {
            const city = document.getElementById('c-city').value;
            const branch = document.getElementById('c-branch').value;
            if(!city || !branch) return alert("–í–≤–µ–¥—ñ—Ç—å –º—ñ—Å—Ç–æ —Ç–∞ –Ω–æ–º–µ—Ä –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è!");
            delivery = `–ù–æ–≤–∞ –ü–æ—à—Ç–∞ (–º. ${city}, –í—ñ–¥–¥. ‚Ññ${branch})`;
        }

        // –†–û–ó–£–ú–ù–ï –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø –ó –ü–ï–†–ï–•–û–ü–õ–ï–ù–ù–Ø–ú –ü–û–ú–ò–õ–û–ö
        const { error } = await sb.from('orders').insert([{
            product_id: activeOrderProduct.id, product_title: activeOrderProduct.title, price: activeOrderProduct.price,
            customer_name: name, customer_phone: phone, delivery: delivery, payment: payment, status: '–ù–æ–≤–∏–π'
        }]);

        // –Ø–∫—â–æ –±–∞–∑–∞ –Ω–µ –ø—Ä–∏–π–Ω—è–ª–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è - —Å–∞–π—Ç —Å–∫–∞–∂–µ —á–æ–º—É
        if (error) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –ë–î:", error);
            alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö: " + error.message);
            return; // –ó—É–ø–∏–Ω—è—î–º–æ —Å–∫—Ä–∏–ø—Ç!
        }

        const tgBotToken = "–¢–í–û–ô_–¢–û–ö–ï–ù"; 
        const tgChatId = "–¢–í–û–ô_ID";      
        
        if(tgBotToken !== "–¢–í–û–ô_–¢–û–ö–ï–ù") {
            const msg = `üî• –ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è!\n\nüõí –¢–æ–≤–∞—Ä: ${activeOrderProduct.title}\nüí∞ –°—É–º–∞: ${activeOrderProduct.price} –≥—Ä–Ω\n\nüë§ –ö–ª—ñ—î–Ω—Ç: ${name}\nüìû –¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\nüöö –î–æ—Å—Ç–∞–≤–∫–∞: ${delivery}\nüí≥ –û–ø–ª–∞—Ç–∞: ${payment}`;
            fetch(`https://api.telegram.org/bot${tgBotToken}/sendMessage?chat_id=${tgChatId}&text=${encodeURIComponent(msg)}`)
                .catch(err => console.error("–ü–æ–º–∏–ª–∫–∞ Telegram:", err));
        }

        alert("‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ! –ú–∏ –∑ –≤–∞–º–∏ –∑–≤'—è–∂–µ–º–æ—Å—è.");
        
        document.getElementById('c-name').value = '';
        document.getElementById('c-phone').value = '';
        document.getElementById('c-city').value = '';
        document.getElementById('c-branch').value = '';
        
        closeOrder();
    }
</script>
</body>
</html>
