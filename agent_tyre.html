<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI –ü—Ä–∏–π–º–∞–ª—å–Ω–∏–∫ –®–∏–Ω</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        :root { --bg: #0d0f12; --olive: #556b2f; --text: #d1d5db; --card-bg: #14171c; }
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: sans-serif; 
            padding: 20px; 
            text-align: center; 
            font-size: 16px; /* –ö–æ–º—Ñ–æ—Ä—Ç–Ω–∏–π —Ä–æ–∑–º—ñ—Ä –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è */
        }
        .panel { 
            background: var(--card-bg); 
            padding: 25px; 
            border-radius: 20px; 
            border: 1px solid var(--olive); 
            max-width: 600px; 
            margin: auto; 
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5); /* –û–±'—î–º–Ω–∏–π –µ—Ñ–µ–∫—Ç */
        }
        input[type="password"], input[type="number"] { 
            width: 100%; 
            padding: 15px; 
            border-radius: 12px; 
            background: #000; 
            color: #fff; 
            border: 1px solid #444; 
            margin-bottom: 20px; 
            box-sizing: border-box; 
            font-size: 16px;
        }
        .file-upload-wrapper {
            background: #0a0c0e;
            padding: 15px;
            border-radius: 12px;
            border: 1px dashed var(--olive);
            margin-bottom: 15px;
            text-align: left;
        }
        .file-upload-wrapper label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #aaa;
        }
        input[type="file"] {
            color: #fff;
        }
        .btn { 
            background: linear-gradient(180deg, var(--olive) 0%, #3e4e22 100%); 
            color: white; 
            padding: 20px; 
            width: 100%; 
            border-radius: 15px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 10px;
            margin-bottom: 10px; 
            border: 1px solid #556b2f; 
            font-size: 18px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5), inset 0 2px 2px rgba(255,255,255,0.2);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            transition: all 0.2s;
        }
        .btn:active {
            transform: translateY(2px);
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.6);
        }
        #status { 
            margin-top: 20px; 
            background: #000; 
            padding: 15px; 
            border-radius: 12px; 
            color: #00ff41; 
            text-align: left; 
            height: 250px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 14px; 
            border: 1px solid #222;
        }
        .back-link { display: block; margin-bottom: 20px; color: #888; text-decoration: none; font-size: 16px;}
    </style>
</head>
<body>

    <a href="dashboard.html" class="back-link">‚Üê –ù–∞–∑–∞–¥ —É –ö–∞–±—ñ–Ω–µ—Ç</a>

    <div class="panel">
        <h2 style="color:var(--olive); text-transform: uppercase;">AI –ü—Ä–∏–π–º–∞–ª—å–Ω–∏–∫ –®–∏–Ω</h2>
        
        <input type="password" id="apiKey" placeholder="–í—Å—Ç–∞–≤—Ç–µ Google API Key...">
        <input type="number" id="price" placeholder="–¶—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É (–≥—Ä–Ω)..." required>

        <div class="file-upload-wrapper">
            <label>1. –§–æ—Ç–æ –ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä–∞ (—Å—Ç–∞–Ω):</label>
            <input type="file" id="photo1" accept="image/*">
        </div>
        <div class="file-upload-wrapper">
            <label>2. –§–æ—Ç–æ –±—Ä–µ–Ω–¥—É (–Ω–∞–∑–≤–∞):</label>
            <input type="file" id="photo2" accept="image/*">
        </div>
        <div class="file-upload-wrapper">
            <label>3. –§–æ—Ç–æ –º–∞—Ä–∫—É–≤–∞–Ω–Ω—è (—Ä–æ–∑–º—ñ—Ä):</label>
            <input type="file" id="photo3" accept="image/*">
        </div>

        <button class="btn" onclick="processTire()">–û–ù–ê–õ–Ü–ó–£–í–ê–¢–ò –¢–ê –î–û–î–ê–¢–ò</button>
        <div id="status">> –û—á—ñ–∫—É–≤–∞–Ω–Ω—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ–π...</div>
    </div>

    <script>
        const sb = supabase.createClient(CONFIG.SB_URL, CONFIG.SB_KEY);

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó —Ñ–∞–π–ª—É —É Base64 (–Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –¥–ª—è –Ü–Ü)
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function logStatus(msg, isError = false) {
            const statusBox = document.getElementById('status');
            const color = isError ? '#ff4444' : '#00ff41';
            statusBox.innerHTML += `<br><span style="color:${color}">${msg}</span>`;
            statusBox.scrollTop = statusBox.scrollHeight;
        }

        async function processTire() {
            const key = document.getElementById('apiKey').value;
            const price = document.getElementById('price').value;
            const file1 = document.getElementById('photo1').files[0];
            const file2 = document.getElementById('photo2').files[0];
            const file3 = document.getElementById('photo3').files[0];

            if(!key) return logStatus("‚ùå –ü–æ–º–∏–ª–∫–∞: –í—Å—Ç–∞–≤—Ç–µ API –∫–ª—é—á Gemini!", true);
            if(!price) return logStatus("‚ùå –ü–æ–º–∏–ª–∫–∞: –í–∫–∞–∂—ñ—Ç—å —Ü—ñ–Ω—É —Ç–æ–≤–∞—Ä—É!", true);
            if(!file1 || !file2 || !file3) return logStatus("‚ùå –ü–æ–º–∏–ª–∫–∞: –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –≤—Å—ñ 3 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó!", true);

            logStatus("‚è≥ –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ–π...");
            
            try {
                // 1. –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó
                const base64_1 = await fileToBase64(file1);
                const base64_2 = await fileToBase64(file2);
                const –¥—ñbase64_3 = await fileToBase64(file3);

                // 2. –ó–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –Ü–Ü –∑ 3-–º–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏
                logStatus("üß† –Ü–Ü –∞–Ω–∞–ª—ñ–∑—É—î –ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä, –±—Ä–µ–Ω–¥ —Ç–∞ —Ä–æ–∑–º—ñ—Ä...");
                
                const promptText = `–¢–∏ - –µ–∫—Å–ø–µ—Ä—Ç –∑ –∞–≤—Ç–æ–º–æ–±—ñ–ª—å–Ω–∏—Ö —à–∏–Ω. –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π —Ü—ñ 3 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó –æ–¥–Ω—ñ—î—ó –≤–∂–∏–≤–∞–Ω–æ—ó —à–∏–Ω–∏. 
                –í–∏–∑–Ω–∞—á –±—Ä–µ–Ω–¥, –º–æ–¥–µ–ª—å, —Ä–æ–∑–º—ñ—Ä, —Å–µ–∑–æ–Ω (–ó–∏–º–æ–≤–∞/–õ—ñ—Ç–Ω—è/–í—Å–µ—Å–µ–∑–æ–Ω–Ω–∞) —Ç–∞ –æ—Ü—ñ–Ω–∏ –∑–∞–ª–∏—à–æ–∫ –ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ '–ë–ª–∏–∑—å–∫–æ 6–º–º' –∞–±–æ '–ì–∞—Ä–Ω–∏–π —Å—Ç–∞–Ω').
                –ù–∞–ø–∏—à–∏ –ø—Ä–∏–≤–∞–±–ª–∏–≤—É –Ω–∞–∑–≤—É (title) —Ç–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–∏–π –æ–ø–∏—Å (description) —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é. –û–ø–∏—Å –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ —Ç–µ—Ö–Ω—ñ—á–Ω—ñ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ç–∞ –ø–µ—Ä–µ–≤–∞–≥–∏.
                –í–ê–ñ–õ–ò–í–û: –ü–æ–≤–µ—Ä–Ω–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –í–ò–ö–õ–Æ–ß–ù–û —É —Ñ–æ—Ä–º–∞—Ç—ñ JSON –±–µ–∑ –º–∞—Ä–∫–¥–∞—É–Ω—É, –±–µ–∑ –±–ª–æ–∫—ñ–≤ –∫–æ–¥—É. 
                –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON: {"brand": "", "model": "", "size": "", "season": "", "tread_depth": "", "title": "", "description": ""}`;

                const payload = {
                    contents: [{
                        parts: [
                            { text: promptText },
                            { inline_data: { mime_type: file1.type, data: base64_1 } },
                            { inline_data: { mime_type: file2.type, data: base64_2 } },
                            { inline_data: { mime_type: file3.type, data: –¥—ñbase64_3 } }
                        ]
                    }],
                    generationConfig: { temperature: 0.2 } // –ù–∏–∑—å–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö
                };

                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –º–æ–¥–µ–ª—å, —â–æ –ø—ñ–¥—Ç—Ä–∏–º—É—î Vision
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                    method: "POST", 
                    headers: {"Content-Type":"application/json"},
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                
                if(!res.ok) throw new Error(data.error.message || "–ü–æ–º–∏–ª–∫–∞ API Gemini");

                let rawText = data.candidates[0].content.parts[0].text;
                // –û—á–∏—â–∞—î–º–æ –≤—ñ–¥ –º–æ–∂–ª–∏–≤–∏—Ö –±–ª–æ–∫—ñ–≤ markdown ```json ... ```
                rawText = rawText.replace(/```json/gi, '').replace(/```/gi, '').trim();
                
                const aiResult = JSON.parse(rawText);
                logStatus(`‚úÖ –†–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ: ${aiResult.brand} ${aiResult.size}`);

                // 3. –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó (–≤–∏—Ç—è–≥—É—î–º–æ —Ä–∞–¥—ñ—É—Å, –Ω–∞–ø—Ä. –∑ "175/65 R15" –±–µ—Ä–µ–º–æ "R15")
                let radiusCategory = "–Ü–Ω—à–µ";
                const radiusMatch = aiResult.size.match(/R\d{2}/i);
                if(radiusMatch) {
                    radiusCategory = radiusMatch[0].toUpperCase();
                }

                logStatus("üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –±–∞–∑—É –¥–∞–Ω–∏—Ö (Supabase)...");

                // 4. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ Supabase. (–ü–û–ö–ò –©–û –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –±–µ–∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ–π –≤ –±–∞–∑—ñ, —â–æ–± –Ω–µ –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Ç. –§–æ—Ç–æ –Ω–∞–ª–∞—à—Ç—É—î–º–æ –æ–∫—Ä–µ–º–æ)
                const { error: dbError } = await sb.from('products').insert([{
                    brand: aiResult.brand,
                    model: aiResult.model,
                    size: aiResult.size,
                    season: aiResult.season,
                    tread_depth: aiResult.tread_depth,
                    title: aiResult.title,
                    description: aiResult.description,
                    price: parseFloat(price),
                    category: radiusCategory,
                    status: '–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'
                }]);

                if(dbError) throw dbError;

                logStatus(`üéâ –£—Å–ø—ñ—à–Ω–æ! –¢–æ–≤–∞—Ä "${aiResult.title}" –¥–æ–¥–∞–Ω–æ –¥–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó ${radiusCategory}.`);
                
                // –û—á–∏—â–µ–Ω–Ω—è —Ñ–æ—Ä–º–∏
                document.getElementById('price').value = '';
                document.getElementById('photo1').value = '';
                document.getElementById('photo2').value = '';
                document.getElementById('photo3').value = '';

            } catch(error) {
                logStatus(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>
