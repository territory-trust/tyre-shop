<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü—Ä–∏–π–æ–º –®–∏–Ω–∏ ‚Äî Tyre Agent</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        :root { --bg: #0a0c10; --panel: #14171c; --olive: #8fbc55; --text: #e5e7eb; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; font-size: 16px; }
        .container { max-width: 500px; margin: 0 auto; }
        h2 { color: var(--olive); text-align: center; text-transform: uppercase; letter-spacing: 2px; }
        .card { background: var(--panel); padding: 20px; border-radius: 16px; border: 1px solid #333; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        label { display: block; margin: 15px 0 5px; color: #888; font-size: 14px; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #000; color: #fff; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--olive); }
        .btn { background: linear-gradient(180deg, #556b2f 0%, #3e4e22 100%); color: #fff; border: none; width: 100%; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 0 #283315; }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        #status { margin-top: 20px; padding: 15px; border-radius: 8px; background: #000; font-size: 13px; border-left: 4px solid var(--olive); white-space: pre-wrap; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>–î–æ–¥–∞—Ç–∏ –®–∏–Ω—É</h2>
    <div class="card">
        <label>API –ö–ª—é—á Gemini:</label>
        <input type="password" id="apiKey" placeholder="–í—Å—Ç–∞–≤—Ç–µ –∫–ª—é—á —Å—é–¥–∏...">

        <label>–¶—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É (–≥—Ä–Ω):</label>
        <input type="number" id="price" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 1500">

        <label>1. –§–æ—Ç–æ –ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä–∞:</label>
        <input type="file" id="photo1" accept="image/*" capture="camera">

        <label>2. –§–æ—Ç–æ –±—Ä–µ–Ω–¥—É/–º–æ–¥–µ–ª—ñ:</label>
        <input type="file" id="photo2" accept="image/*" capture="camera">

        <label>3. –§–æ—Ç–æ —Ä–æ–∑–º—ñ—Ä—É (–º–∞—Ä–∫—É–≤–∞–Ω–Ω—è):</label>
        <input type="file" id="photo3" accept="image/*" capture="camera">

        <button class="btn" onclick="processTire()">–ê–ù–ê–õ–Ü–ó–£–í–ê–¢–ò –¢–ê –î–û–î–ê–¢–ò</button>
    </div>
    <div id="status"></div>
</div>

<script>
    const sb = supabase.createClient(CONFIG.SB_URL, CONFIG.SB_KEY);

    function logStatus(msg, isError = false) {
        const s = document.getElementById('status');
        s.style.display = 'block';
        s.style.borderLeftColor = isError ? '#ff4444' : '#8fbc55';
        s.innerText += msg + '\n';
        console.log(msg);
    }

    async function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });
    }

    async function processTire() {
        const key = document.getElementById('apiKey').value;
        const price = document.getElementById('price').value;
        const f1 = document.getElementById('photo1').files[0];
        const f2 = document.getElementById('photo2').files[0];
        const f3 = document.getElementById('photo3').files[0];

        if(!key || !price || !f1 || !f2 || !f3) {
            alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è —Ç–∞ –≤–∏–±–µ—Ä—ñ—Ç—å 3 —Ñ–æ—Ç–æ!");
            return;
        }

        document.getElementById('status').innerText = '';
        logStatus("‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ —É —Å—Ö–æ–≤–∏—â–µ...");

        try {
            const upload = async (file, tag) => {
                const name = `${Date.now()}_${tag}.jpg`;
                const { data, error } = await sb.storage.from('tyres').upload(name, file);
                if (error) throw error;
                return sb.storage.from('tyres').getPublicUrl(name).data.publicUrl;
            };

            const u1 = await upload(f1, 'tread');
            const u2 = await upload(f2, 'brand');
            const u3 = await upload(f3, 'size');

            logStatus("üß† –Ü–Ü –∞–Ω–∞–ª—ñ–∑—É—î —à–∏–Ω–∏...");
            const b1 = await fileToBase64(f1);
            const b2 = await fileToBase64(f2);
            const b3 = await fileToBase64(f3);

            const prompt = `–ê–Ω–∞–ª—ñ–∑—É–π 3 —Ñ–æ—Ç–æ —à–∏–Ω–∏. –ü–æ–≤–µ—Ä–Ω–∏ JSON: {"brand":"","model":"","size":"","season":"","tread_depth":"","title":"","description":""}. –ú–æ–≤–∞: —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞.`;

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ contents: [{ parts: [
                    { text: prompt },
                    { inline_data: { mime_type: f1.type, data: b1 } },
                    { inline_data: { mime_type: f2.type, data: b2 } },
                    { inline_data: { mime_type: f3.type, data: b3 } }
                ]}]})
            });

            const aiData = await res.json();
            const ai = JSON.parse(aiData.candidates[0].content.parts[0].text.replace(/```json|```/gi, ''));
            const radius = ai.size.match(/R\d{2}/i)?.[0]?.toUpperCase() || "–Ü–Ω—à–µ";

            logStatus("üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –±–∞–∑—É...");
            await sb.from('products').insert([{
                brand: ai.brand, model: ai.model, size: ai.size, season: ai.season,
                tread_depth: ai.tread_depth, title: ai.title, description: ai.description,
                price: parseFloat(price), category: radius,
                image_url_1: u1, image_url_2: u2, image_url_3: u3, status: '–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'
            }]);

            logStatus("üéâ –¢–æ–≤–∞—Ä —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ –∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—è–º–∏!");
        } catch(e) {
            logStatus("‚ùå –ü–æ–º–∏–ª–∫–∞: " + e.message, true);
        }
    }
</script>
</body>
</html>
