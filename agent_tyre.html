<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–î–æ–¥–∞—Ç–∏ –®–∏–Ω—É ‚Äî Tyre Agent</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        :root { --bg: #0a0c10; --panel: #14171c; --olive: #8fbc55; --text: #e5e7eb; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; margin: 0; font-size: 16px; }
        .nav-top { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-btn { flex: 1; background: #222; color: #fff; padding: 12px; border-radius: 10px; text-align: center; text-decoration: none; font-weight: bold; border: 1px solid #333; box-shadow: 0 4px 0 #111; }
        .nav-btn:active { transform: translateY(2px); box-shadow: none; }
        .card { background: var(--panel); padding: 20px; border-radius: 16px; border: 1px solid #333; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        h2 { color: var(--olive); text-align: center; margin-top: 0; text-transform: uppercase; font-size: 20px; }
        label { display: block; margin: 15px 0 5px; color: #888; font-size: 14px; }
        input[type="number"], input[type="password"] { width: 100%; padding: 14px; border-radius: 8px; border: 1px solid #333; background: #000; color: #fff; box-sizing: border-box; outline: none; font-size: 16px; }
        input:focus { border-color: var(--olive); }
        
        .flex-btns { display: flex; gap: 10px; margin-bottom: 15px; }
        .file-label { flex: 1; background: #000; border: 1px solid var(--olive); padding: 12px 5px; text-align: center; border-radius: 8px; color: var(--olive); cursor: pointer; font-weight: bold; font-size: 14px; margin: 0; transition: 0.3s; display: flex; justify-content: center; align-items: center;}
        input[type="file"] { display: none; }
        
        .btn { background: linear-gradient(180deg, #556b2f 0%, #3e4e22 100%); color: #fff; border: none; width: 100%; padding: 18px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 16px; box-shadow: 0 4px 0 #283315; transition: 0.2s; }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #status { margin-top: 20px; padding: 15px; border-radius: 8px; background: #000; font-size: 14px; border-left: 4px solid var(--olive); white-space: pre-wrap; display: none; }
    </style>
</head>
<body>

<div class="nav-top">
    <a href="dashboard.html" class="nav-btn">üîô –í –ö–∞–±—ñ–Ω–µ—Ç</a>
    <a href="index.html" class="nav-btn">üè™ –í –ú–∞–≥–∞–∑–∏–Ω</a>
</div>

<div class="card">
    <h2>‚ûï –ù–æ–≤–∏–π —Ç–æ–≤–∞—Ä</h2>
    
    <label>Google API Key (–∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è):</label>
    <input type="password" id="apiKey" placeholder="–í—Å—Ç–∞–≤—Ç–µ –∫–ª—é—á">
    
    <label>–¶—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É (–≥—Ä–Ω): <br><small style="color:#666">–ó–∞–ª–∏—à—Ç–µ –ø–æ—Ä–æ–∂–Ω—ñ–º, —â–æ–± –Ü–Ü –æ—Ü—ñ–Ω–∏–≤ —Å–∞–º</small></label>
    <input type="number" id="price" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 1500">
    
    <label>1. –§–æ—Ç–æ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ (–ì–û–õ–û–í–ù–ï):</label>
    <div class="flex-btns">
        <label class="file-label" id="l1_cam"><input type="file" id="p1_cam" accept="image/*" capture="environment" onchange="updLbl('l1_cam', 'p1_cam', 1)">üì∑ –ö–∞–º–µ—Ä–∞</label>
        <label class="file-label" id="l1_gal"><input type="file" id="p1_gal" accept="image/*" onchange="updLbl('l1_gal', 'p1_gal', 1)">üñº –ì–∞–ª–µ—Ä–µ—è</label>
    </div>

    <label>2. –§–æ—Ç–æ —Ä–æ–∑–º—ñ—Ä—É (–º–∞—Ä–∫—É–≤–∞–Ω–Ω—è):</label>
    <div class="flex-btns">
        <label class="file-label" id="l2_cam"><input type="file" id="p2_cam" accept="image/*" capture="environment" onchange="updLbl('l2_cam', 'p2_cam', 2)">üì∑ –ö–∞–º–µ—Ä–∞</label>
        <label class="file-label" id="l2_gal"><input type="file" id="p2_gal" accept="image/*" onchange="updLbl('l2_gal', 'p2_gal', 2)">üñº –ì–∞–ª–µ—Ä–µ—è</label>
    </div>

    <label>3. –§–æ—Ç–æ –±—Ä–µ–Ω–¥—É/–º–æ–¥–µ–ª—ñ:</label>
    <div class="flex-btns">
        <label class="file-label" id="l3_cam"><input type="file" id="p3_cam" accept="image/*" capture="environment" onchange="updLbl('l3_cam', 'p3_cam', 3)">üì∑ –ö–∞–º–µ—Ä–∞</label>
        <label class="file-label" id="l3_gal"><input type="file" id="p3_gal" accept="image/*" onchange="updLbl('l3_gal', 'p3_gal', 3)">üñº –ì–∞–ª–µ—Ä–µ—è</label>
    </div>

    <label>4. –§–æ—Ç–æ –ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä–∞:</label>
    <div class="flex-btns">
        <label class="file-label" id="l4_cam"><input type="file" id="p4_cam" accept="image/*" capture="environment" onchange="updLbl('l4_cam', 'p4_cam', 4)">üì∑ –ö–∞–º–µ—Ä–∞</label>
        <label class="file-label" id="l4_gal"><input type="file" id="p4_gal" accept="image/*" onchange="updLbl('l4_gal', 'p4_gal', 4)">üñº –ì–∞–ª–µ—Ä–µ—è</label>
    </div>
    
    <button class="btn" id="mainBtn" onclick="start()">–ê–ù–ê–õ–Ü–ó –¢–ê –ü–£–ë–õ–Ü–ö–ê–¶–Ü–Ø</button>
    <div id="status"></div>
</div>

<script>
    const sb = supabase.createClient(CONFIG.SB_URL, CONFIG.SB_KEY);
    let selectedFiles = [null, null, null, null];

    window.onload = () => {
        const savedKey = localStorage.getItem('gemini_key');
        if(savedKey) document.getElementById('apiKey').value = savedKey;
    };

    function updLbl(labelId, inputId, index) { 
        const file = document.getElementById(inputId).files[0];
        if(file) {
            selectedFiles[index - 1] = file;
            document.getElementById(`l${index}_cam`).style.background = '#000';
            document.getElementById(`l${index}_gal`).style.background = '#000';
            document.getElementById(`l${index}_cam`).innerHTML = 'üì∑ –ö–∞–º–µ—Ä–∞';
            document.getElementById(`l${index}_gal`).innerHTML = 'üñº –ì–∞–ª–µ—Ä–µ—è';
            
            const active = document.getElementById(labelId);
            active.style.background = '#1a2e1a';
            active.innerHTML = '‚úÖ –Ñ —Ñ–æ—Ç–æ';
        }
    }

    function log(msg, isErr = false) {
        const s = document.getElementById('status');
        s.style.display = 'block'; s.style.borderLeftColor = isErr ? '#ff4444' : '#8fbc55';
        s.innerText += msg + '\n';
        s.scrollTop = s.scrollHeight;
    }

    // –°—Ç–∏—Å–Ω–µ–Ω–Ω—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ–π –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ñ–π –ø–∞–º'—è—Ç—ñ —Ç–µ–ª–µ—Ñ–æ–Ω—É
    async function compressImg(file) {
        if(!file) return null;
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; 
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height && width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } 
                    else if (height > MAX_WIDTH) { width *= MAX_WIDTH / height; height = MAX_WIDTH; }
                    
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((blob) => {
                        const newFile = new File([blob], file.name, { type: 'image/jpeg' });
                        const reader2 = new FileReader();
                        reader2.readAsDataURL(blob);
                        reader2.onloadend = () => resolve({ file: newFile, b64: reader2.result.split(',')[1] });
                    }, 'image/jpeg', 0.7); 
                };
            };
        });
    }

    async function start() {
        const btn = document.getElementById('mainBtn');
        const k = document.getElementById('apiKey').value;
        let pr = document.getElementById('price').value;
        
        if(!k || !selectedFiles[0] || !selectedFiles[3]) return alert("–í–≤–µ–¥—ñ—Ç—å –∫–ª—é—á, —Ñ–æ—Ç–æ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ (1) —Ç–∞ —Ñ–æ—Ç–æ –ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä–∞ (4)!");
        
        localStorage.setItem('gemini_key', k);
        localStorage.setItem('is_admin', 'true');

        btn.disabled = true; document.getElementById('status').innerText = '';
        
        try {
            log("‚è≥ –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ–π...");
            const cQty = await compressImg(selectedFiles[0]);
            const cSize = await compressImg(selectedFiles[1]);
            const cBrand = await compressImg(selectedFiles[2]);
            const cTread = await compressImg(selectedFiles[3]);

            log("‚òÅÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —É —Å—Ö–æ–≤–∏—â–µ...");
            const up = async (cObj, tag) => {
                if(!cObj) return null;
                const n = `${Date.now()}_${tag}.jpg`;
                const { error } = await sb.storage.from('tyres').upload(n, cObj.file);
                if (error) throw error;
                return sb.storage.from('tyres').getPublicUrl(n).data.publicUrl;
            };

            const u1 = await up(cQty, 'qty');
            const u2 = await up(cSize, 'size');
            const u3 = await up(cBrand, 'brand');
            const u4 = await up(cTread, 'tread'); 

            log("üß† –ê–Ω–∞–ª—ñ–∑ –Ü–Ü...");
            
            const parts = [{ text: "–¢–∏ –µ–∫—Å–ø–µ—Ä—Ç –∑ –æ—Ü—ñ–Ω–∫–∏ –±/–≤ —à–∏–Ω. –ü–æ–≤–µ—Ä–Ω–∏ JSON: {\"brand\":\"\", \"size\":\"\", \"season\":\"\", \"tread_depth\":\"–û—Ü—ñ–Ω–∏ –∑–Ω–æ—Å (—É %) —Ç–∞ –∑–∞–ª–∏—à–æ–∫ –ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä–∞ (—É –º–º)\", \"quantity\":\"–°–£–í–û–†–û –ø–æ—Ä–∞—Ö—É–π —Ñ—ñ–∑–∏—á–Ω—ñ –≥—É–º–æ–≤—ñ –∫–æ–ª–∞ –¢–Ü–õ–¨–ö–ò –Ω–∞ –ü–ï–†–®–û–ú–£ —Ñ–æ—Ç–æ –Ω–∞ –ø–µ—Ä–µ–¥–Ω—å–æ–º—É –ø–ª–∞–Ω—ñ! –Ü–≥–Ω–æ—Ä—É–π –≤—Å–µ –Ω–∞ –∑–∞–¥–Ω—å–æ–º—É —Ñ–æ–Ω—ñ! –Ø–∫—â–æ –ª–µ–∂–∏—Ç—å 1 —à–∏–Ω–∞ - —Å—É–≤–æ—Ä–æ –ø–∏—à–∏ '1 —à—Ç.', —è–∫—â–æ 2 - '–ü–∞—Ä–∞ (2 —à—Ç.)', —è–∫—â–æ 4 - '–ö–æ–º–ø–ª–µ–∫—Ç (4 —à—Ç.)'\", \"specs\":\"–¢–µ—Ö–Ω—ñ—á–Ω—ñ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏\", \"benefits\":\"–í–∏–≥–æ–¥–∞ —Ç–∞ –ø–µ—Ä–µ–≤–∞–≥–∏ –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞\", \"rec_price\": \"–û—Ü—ñ–Ω–æ—á–Ω–∞ —Ä–∏–Ω–∫–æ–≤–∞ —Ü—ñ–Ω–∞ (—Ç—ñ–ª—å–∫–∏ —Ü–∏—Ñ—Ä–∞)\"}. –ú–æ–≤–∞: —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞. –ë–µ–∑ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è markdown." }];
            
            if(cQty) parts.push({ inline_data: { mime_type: "image/jpeg", data: cQty.b64 } });
            if(cSize) parts.push({ inline_data: { mime_type: "image/jpeg", data: cSize.b64 } });
            if(cBrand) parts.push({ inline_data: { mime_type: "image/jpeg", data: cBrand.b64 } });
            if(cTread) parts.push({ inline_data: { mime_type: "image/jpeg", data: cTread.b64 } });

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${k}`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ contents: [{ parts: parts }] })
            });

            const d = await res.json();
            if (d.error) throw new Error(d.error.message);
            
            const raw = d.candidates[0].content.parts[0].text.replace(/```json|```/gi, '').trim();
            const ai = JSON.parse(raw);
            const rad = (ai.size || '').match(/R\d{2}/i)?.[0]?.toUpperCase() || "–Ü–Ω—à–µ";
            
            if(!pr) {
                const conf = confirm(`ü§ñ –Ü–Ü —Ä–µ–∫–æ–º–µ–Ω–¥—É—î —Ü—ñ–Ω—É: ${ai.rec_price} –≥—Ä–Ω.\n–ó–±–µ—Ä–µ–≥—Ç–∏ —Ü—é —Ü—ñ–Ω—É?`);
                pr = conf ? ai.rec_price : prompt("–í–≤–µ–¥—ñ—Ç—å —Å–≤–æ—é —Ü—ñ–Ω—É (–≥—Ä–Ω):", ai.rec_price);
                if(!pr) pr = 0; 
            }

            log("üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –±–∞–∑—É...");
            const title = `${ai.size} | ${ai.brand} | ${ai.season} | ${ai.quantity}`;

            const { error: dbErr } = await sb.from('products').insert([{
                brand: ai.brand, size: ai.size, season: ai.season, tread_depth: ai.tread_depth, 
                quantity: ai.quantity, specs: ai.specs, benefits: ai.benefits, title: title,
                price: parseFloat(pr), category: rad,
                image_url_1: u1, image_url_2: u2, image_url_3: u3, image_url_4: u4, status: '–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'
            }]);

            if(dbErr) throw dbErr;

            log("‚úÖ –£–°–ü–Ü–®–ù–û! –ú–æ–∂–Ω–∞ –¥–æ–¥–∞–≤–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—É.");
            document.getElementById('price').value = '';
            selectedFiles = [null, null, null, null];
            document.querySelectorAll('input[type=file]').forEach(i => i.value = '');
            for(let i=1; i<=4; i++) {
                document.getElementById(`l${i}_cam`).style.background = '#000';
                document.getElementById(`l${i}_gal`).style.background = '#000';
                document.getElementById(`l${i}_cam`).innerHTML = 'üì∑ –ö–∞–º–µ—Ä–∞';
                document.getElementById(`l${i}_gal`).innerHTML = 'üñº –ì–∞–ª–µ—Ä–µ—è';
            }
            setTimeout(() => btn.disabled = false, 2000);
        } catch(e) { log("‚ùå –ü–æ–º–∏–ª–∫–∞: " + e.message, true); btn.disabled = false; }
    }
</script>
</body>
</html>
