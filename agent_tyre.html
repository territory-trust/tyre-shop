<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–î–æ–¥–∞—Ç–∏ –®–∏–Ω—É ‚Äî Tyre Agent</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        :root { --bg: #0a0c10; --panel: #14171c; --olive: #8fbc55; --text: #e5e7eb; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; padding: 20px; }
        .card { background: var(--panel); padding: 20px; border-radius: 16px; border: 1px solid #333; max-width: 500px; margin: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { color: var(--olive); text-align: center; margin-top: 0; text-transform: uppercase; font-size: 20px; }
        label { display: block; margin: 15px 0 5px; color: #888; font-size: 13px; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #000; color: #fff; box-sizing: border-box; margin-bottom: 5px; font-size: 16px; outline: none; }
        input:focus { border-color: var(--olive); }
        .btn { background: linear-gradient(180deg, #556b2f 0%, #3e4e22 100%); color: #fff; border: none; width: 100%; padding: 18px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 16px; box-shadow: 0 4px 0 #283315; transition: 0.2s; }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #status { margin-top: 20px; padding: 15px; border-radius: 8px; background: #000; font-size: 13px; border-left: 4px solid var(--olive); white-space: pre-wrap; display: none; line-height: 1.5; }
        .success-flash { border-left-color: #00ff41 !important; background: #001a05 !important; }
    </style>
</head>
<body>

<div class="card">
    <h2>‚ûï –ù–æ–≤–∏–π —Ç–æ–≤–∞—Ä</h2>
    
    <label>Google API Key (–∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è):</label>
    <input type="password" id="apiKey" placeholder="–í—Å—Ç–∞–≤—Ç–µ –∫–ª—é—á">
    
    <label>–¶—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É (–≥—Ä–Ω):</label>
    <input type="number" id="price" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 1450">
    
    <label>1. –§–æ—Ç–æ –ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä–∞ (–≥–æ–ª–æ–≤–Ω–µ):</label>
    <input type="file" id="p1" accept="image/*">
    
    <label>2. –§–æ—Ç–æ –±—Ä–µ–Ω–¥—É:</label>
    <input type="file" id="p2" accept="image/*">
    
    <label>3. –§–æ—Ç–æ —Ä–æ–∑–º—ñ—Ä—É:</label>
    <input type="file" id="p3" accept="image/*">
    
    <button class="btn" id="mainBtn" onclick="start()">–î–û–î–ê–¢–ò –í –ú–ê–ì–ê–ó–ò–ù</button>
    <div id="status"></div>
</div>

<script>
    const sb = supabase.createClient(CONFIG.SB_URL, CONFIG.SB_KEY);

    function log(msg, isError = false) {
        const s = document.getElementById('status');
        s.style.display = 'block';
        if(isError) s.style.borderLeftColor = '#ff4444';
        else s.style.borderLeftColor = '#8fbc55';
        s.innerText += msg + '\n';
        s.scrollTop = s.scrollHeight;
    }

    async function toB64(file) {
        return new Promise(r => {
            const rd = new FileReader();
            rd.readAsDataURL(file);
            rd.onload = () => r(rd.result.split(',')[1]);
        });
    }

    async function start() {
        const btn = document.getElementById('mainBtn');
        const statusBox = document.getElementById('status');
        const key = document.getElementById('apiKey').value;
        const pr = document.getElementById('price').value;
        const f1 = document.getElementById('p1').files[0];
        const f2 = document.getElementById('p2').files[0];
        const f3 = document.getElementById('p3').files[0];

        if(!key || !pr || !f1) return alert("–í–∫–∞–∂—ñ—Ç—å —Ü—ñ–Ω—É —Ç–∞ –≤–∏–±–µ—Ä—ñ—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä–∞!");

        btn.disabled = true;
        statusBox.innerText = '';
        log("‚è≥ –ü–æ—á–∞—Ç–æ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...");

        try {
            const up = async (f, t) => {
                const n = `${Date.now()}_${t}.jpg`;
                const { error } = await sb.storage.from('tyres').upload(n, f);
                if(error) throw error;
                return sb.storage.from('tyres').getPublicUrl(n).data.publicUrl;
            };

            const u1 = await up(f1, '1');
            const u2 = f2 ? await up(f2, '2') : null;
            const u3 = f3 ? await up(f3, '3') : null;

            log("üß† –ê–Ω–∞–ª—ñ–∑ –Ü–Ü —Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–ø–∏—Å—É...");
            const b1 = await toB64(f1);
            
            const prompt = `–¢–∏ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –µ–∫—Å–ø–µ—Ä—Ç –∑ —à–∏–Ω. –û–ø–∏—à–∏ —Ü—é —à–∏–Ω—É. 
            –ù–∞–ø–∏—à–∏ –¥–æ–≤–≥–∏–π —Ç–∞ –ø–µ—Ä–µ–∫–æ–Ω–ª–∏–≤–∏–π –æ–ø–∏—Å (–º—ñ–Ω—ñ–º—É–º 6 —Ä–µ—á–µ–Ω—å). 
            –û–±–æ–≤'—è–∑–∫–æ–≤–æ –∑–≥–∞–¥–∞–π –±–µ–∑–ø–µ–∫—É, –∫–æ–º—Ñ–æ—Ä—Ç —Ç–∞ –∑—á–µ–ø–ª–µ–Ω–Ω—è. 
            –ü–æ–≤–µ—Ä–Ω–∏ –í–ò–ù–Ø–¢–ö–û–í–û JSON: {"brand":"","model":"","size":"","season":"","tread_depth":"","title":"","description":""}. 
            –ú–æ–≤–∞: —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞.`;

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: f1.type, data: b1 } }] }] })
            });

            const d = await res.json();
            let raw = d.candidates[0].content.parts[0].text;
            raw = raw.replace(/```json|```/gi, '').trim();
            
            const ai = JSON.parse(raw);
            const rad = ai.size.match(/R\d{2}/i)?.[0]?.toUpperCase() || "–Ü–Ω—à–µ";

            log("üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –±–∞–∑—É...");
            const { error: dbErr } = await sb.from('products').insert([{
                brand: ai.brand, model: ai.model, size: ai.size, season: ai.season,
                tread_depth: ai.tread_depth, title: ai.title, description: ai.description,
                price: parseFloat(pr), category: rad,
                image_url_1: u1, image_url_2: u2, image_url_3: u3, status: '–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'
            }]);

            if(dbErr) throw dbErr;

            // –£–°–ü–Ü–•: –û—á–∏—â—É—î–º–æ –ø–æ–ª—è –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä—É
            log("‚úÖ –£–°–ü–Ü–®–ù–û –î–û–î–ê–ù–û!");
            statusBox.classList.add('success-flash');
            
            // –û—á–∏—â—É—î–º–æ —Ñ–∞–π–ª–∏ —Ç–∞ —Ü—ñ–Ω—É
            document.getElementById('price').value = '';
            document.getElementById('p1').value = '';
            document.getElementById('p2').value = '';
            document.getElementById('p3').value = '';
            
            setTimeout(() => {
                statusBox.innerText = "–ì–æ—Ç–æ–≤–∏–π –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó —à–∏–Ω–∏...";
                statusBox.classList.remove('success-flash');
                btn.disabled = false;
            }, 3000);

        } catch(e) { 
            log("‚ùå –ü–æ–º–∏–ª–∫–∞: " + e.message, true);
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
