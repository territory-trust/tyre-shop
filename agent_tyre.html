<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–î–æ–¥–∞—Ç–∏ –®–∏–Ω—É ‚Äî Tyre Agent</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        :root { --bg: #0a0c10; --panel: #14171c; --olive: #8fbc55; --text: #e5e7eb; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; padding: 20px; }
        .card { background: var(--panel); padding: 20px; border-radius: 16px; border: 1px solid #333; max-width: 500px; margin: auto; }
        label { display: block; margin: 15px 0 5px; color: #888; font-size: 14px; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #000; color: #fff; box-sizing: border-box; margin-bottom: 10px; }
        .btn { background: linear-gradient(180deg, #556b2f 0%, #3e4e22 100%); color: #fff; border: none; width: 100%; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 0 #283315; }
        #status { margin-top: 20px; padding: 15px; border-radius: 8px; background: #000; font-size: 13px; border-left: 4px solid var(--olive); white-space: pre-wrap; display: none; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="color:var(--olive); text-align:center;">–ù–û–í–ò–ô –¢–û–í–ê–†</h2>
    <input type="password" id="apiKey" placeholder="Google API Key">
    <input type="number" id="price" placeholder="–¶—ñ–Ω–∞ (–≥—Ä–Ω)">
    
    <label>1. –§–æ—Ç–æ –ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä–∞:</label>
    <input type="file" id="p1" accept="image/*">
    
    <label>2. –§–æ—Ç–æ –±—Ä–µ–Ω–¥—É:</label>
    <input type="file" id="p2" accept="image/*">
    
    <label>3. –§–æ—Ç–æ —Ä–æ–∑–º—ñ—Ä—É:</label>
    <input type="file" id="p3" accept="image/*">
    
    <button class="btn" onclick="start()">–î–û–î–ê–¢–ò –í –ú–ê–ì–ê–ó–ò–ù</button>
    <div id="status"></div>
</div>

<script>
    const sb = supabase.createClient(CONFIG.SB_URL, CONFIG.SB_KEY);

    function log(msg) {
        const s = document.getElementById('status');
        s.style.display = 'block';
        s.innerText += msg + '\n';
    }

    async function toB64(file) {
        return new Promise(r => {
            const rd = new FileReader();
            rd.readAsDataURL(file);
            rd.onload = () => r(rd.result.split(',')[1]);
        });
    }

    async function start() {
        const key = document.getElementById('apiKey').value;
        const pr = document.getElementById('price').value;
        const f1 = document.getElementById('p1').files[0];
        const f2 = document.getElementById('p2').files[0];
        const f3 = document.getElementById('p3').files[0];

        if(!key || !pr || !f1) return alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –¥–∞–Ω—ñ!");

        document.getElementById('status').innerText = '';
        log("‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ...");

        try {
            const up = async (f, t) => {
                const n = `${Date.now()}_${t}.jpg`;
                await sb.storage.from('tyres').upload(n, f);
                return sb.storage.from('tyres').getPublicUrl(n).data.publicUrl;
            };

            const u1 = await up(f1, '1');
            const u2 = f2 ? await up(f2, '2') : null;
            const u3 = f3 ? await up(f3, '3') : null;

            log("üß† –ê–Ω–∞–ª—ñ–∑ –Ü–Ü (—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–ø–∏—Å—É)...");
            const b1 = await toB64(f1);
            
            const prompt = `–¢–∏ - –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –∫–æ–ø—ñ—Ä–∞–π—Ç–µ—Ä —É —Å—Ñ–µ—Ä—ñ –∞–≤—Ç–æ. –ù–∞–ø–∏—à–∏ –¥–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å –ë/–í —à–∏–Ω–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ñ–æ—Ç–æ. 
            –ó—Ä–æ–±–∏ 3 –±–ª–æ–∫–∏: 
            1. –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–ë—Ä–µ–Ω–¥ + –ú–æ–¥–µ–ª—å + –≥–æ–ª–æ–≤–Ω–∞ —Ñ—ñ—à–∫–∞). 
            2. –ü–µ—Ä–µ–≤–∞–≥–∏ (–±–µ–∑–ø–µ–∫–∞, –≥–∞–ª—å–º—É–≤–∞–Ω–Ω—è, –∫–æ–º—Ñ–æ—Ä—Ç). 
            3. –°—Ç–∞–Ω (–æ—Ü—ñ–Ω–∏ –≤—ñ–∑—É–∞–ª—å–Ω–æ). 
            –¢–µ–∫—Å—Ç –º–∞—î –±—É—Ç–∏ –ø–µ—Ä–µ–∫–æ–Ω–ª–∏–≤–∏–º, –º—ñ–Ω—ñ–º—É–º 5 —Ä–µ—á–µ–Ω—å. –ú–æ–≤–∞: —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞.
            –§–æ—Ä–º–∞—Ç JSON: {"brand":"","model":"","size":"","season":"","tread_depth":"","title":"","description":""}`;

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: f1.type, data: b1 } }] }] })
            });

            const d = await res.json();
            const ai = JSON.parse(d.candidates[0].content.parts[0].text.replace(/```json|```/gi, ''));
            const rad = ai.size.match(/R\d{2}/i)?.[0]?.toUpperCase() || "–Ü–Ω—à–µ";

            log("üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...");
            await sb.from('products').insert([{
                brand: ai.brand, model: ai.model, size: ai.size, season: ai.season,
                tread_depth: ai.tread_depth, title: ai.title, description: ai.description,
                price: parseFloat(pr), category: rad,
                image_url_1: u1, image_url_2: u2, image_url_3: u3, status: '–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'
            }]);

            log("‚úÖ –ì–æ—Ç–æ–≤–æ! –¢–æ–≤–∞—Ä –Ω–∞ —Å–∞–π—Ç—ñ.");
        } catch(e) { log("‚ùå –ü–æ–º–∏–ª–∫–∞: " + e.message); }
    }
</script>
</body>
</html>
