<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è ‚Äî Tyre Shop</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="config.js"></script>
    <style>
        :root { --bg: #0a0c10; --panel: #14171c; --olive: #8fbc55; --text: #e5e7eb; --red: #ff4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; font-size: 14px;}
        
        .top-nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-link { flex: 1; background: #222; color: #fff; padding: 12px; border-radius: 10px; text-align: center; text-decoration: none; font-weight: bold; border: 1px solid #333; box-shadow: 0 4px 0 #111; }
        .nav-link:active { transform: translateY(2px); box-shadow: none; }
        
        .tabs { display: flex; border-bottom: 2px solid #333; margin-bottom: 20px; overflow-x: auto; white-space: nowrap; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; color: #888; }
        .tab.active { color: var(--olive); border-bottom: 3px solid var(--olive); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid #333; margin-bottom: 12px; }
        .card-header { font-weight: bold; color: #fff; margin-bottom: 8px; font-size: 15px; line-height: 1.3; }
        .card-info { font-size: 13px; color: #aaa; margin-bottom: 10px; line-height: 1.4; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;}
        .stat-box { background: #000; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #222; }
        .stat-box b { display: block; font-size: 22px; color: var(--olive); margin-top: 5px; }
        .chart-container { background: #000; border: 1px solid #222; border-radius: 10px; padding: 10px; margin-bottom: 15px; }
        
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; width: 100%; font-size: 13px; margin-top: 5px;}
        .btn-green { background: var(--olive); color: #000; }
        .btn-red { background: transparent; color: var(--red); border: 1px solid var(--red); }
        
        .filters { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        select { background: #000; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 8px; outline: none;}
        .price-edit { background: #000; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 8px; width: 100px; margin-right: 10px; font-weight: bold; }
        .flex-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;}
    </style>
</head>
<body>

<div class="top-nav">
    <a href="index.html" class="nav-link">üè™ –ú–ê–ì–ê–ó–ò–ù</a>
    <a href="agent_tyre.html" class="nav-link">‚ûï –î–û–î–ê–¢–ò –¢–û–í–ê–†</a>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('orders', this)">üîî –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
    <div class="tab" onclick="switchTab('stock', this)">üì¶ –°–∫–ª–∞–¥</div>
    <div class="tab" onclick="switchTab('stats', this)">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
</div>

<div id="orders" class="tab-content active"><div id="orders-list">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>

<div id="stock" class="tab-content">
    <div class="filters">
        <select id="f-season" onchange="applyFilters()"><option value="">–í—Å—ñ —Å–µ–∑–æ–Ω–∏</option><option value="–ó–∏–º–∞">–ó–∏–º–∞</option><option value="–õ—ñ—Ç–æ">–õ—ñ—Ç–æ</option></select>
        <select id="f-size" onchange="applyFilters()"><option value="">–í—Å—ñ —Ä–æ–∑–º—ñ—Ä–∏</option></select>
    </div>
    <div id="stock-list"></div>
</div>

<div id="stats" class="tab-content">
    <div class="stat-grid" id="stats-grid"></div>
    <div class="chart-container"><canvas id="brandChart"></canvas></div>
    <div class="chart-container"><canvas id="sizeChart"></canvas></div>
</div>

<script>
    const sb = supabase.createClient(CONFIG.SB_URL, CONFIG.SB_KEY);
    let allProducts = [];

    function switchTab(id, el) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active'); el.classList.add('active');
    }

    async function loadData() {
        const [ordRes, prodRes] = await Promise.all([
            sb.from('orders').select('*').order('created_at', {ascending: false}),
            sb.from('products').select('*').order('created_at', {ascending: false})
        ]);
        allProducts = prodRes.data || [];
        
        renderOrders(ordRes.data || []);
        populateFilters(); applyFilters();
        renderStats(ordRes.data || []);
    }

    /* –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è */
    function renderOrders(orders) {
        const box = document.getElementById('orders-list'); box.innerHTML = '';
        const active = orders.filter(o => o.status === '–ù–æ–≤–∏–π');
        if(active.length === 0) return box.innerHTML = '<div class="card" style="text-align:center">–ù–µ–º–∞—î –Ω–æ–≤–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å</div>';
        
        active.forEach(o => {
            box.innerHTML += `
                <div class="card">
                    <div class="card-header">üõí ${o.product_title}</div>
                    <div class="card-info">
                        <b>–ö–ª—ñ—î–Ω—Ç:</b> ${o.customer_name} (${o.customer_phone})<br>
                        <b>–î–æ—Å—Ç–∞–≤–∫–∞:</b> ${o.delivery} | <b>–û–ø–ª–∞—Ç–∞:</b> ${o.payment}<br>
                        üí∞ –°—É–º–∞: <b style="color:var(--olive); font-size:16px">${o.price} –≥—Ä–Ω</b>
                    </div>
                    <button class="btn btn-green" onclick="completeOrder('${o.id}', '${o.product_id}')">‚úÖ –í–ò–ö–û–ù–ê–ù–û (–ü—Ä–æ–¥–∞–Ω–æ)</button>
                </div>`;
        });
    }

    async function completeOrder(oId, pId) {
        if(!confirm("–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è?")) return;
        await sb.from('orders').update({ status: '–í–∏–∫–æ–Ω–∞–Ω–æ' }).eq('id', oId);
        markSold(pId, false); // –ë–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è, –±–æ –≤–∂–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
    }

    /* –°–∫–ª–∞–¥ */
    function populateFilters() {
        const sizes = [...new Set(allProducts.map(p => p.category).filter(Boolean))];
        const szSelect = document.getElementById('f-size');
        sizes.forEach(s => szSelect.innerHTML += `<option value="${s}">${s}</option>`);
    }

    function applyFilters() {
        const sz = document.getElementById('f-size').value;
        const se = document.getElementById('f-season').value;
        let filtered = allProducts.filter(p => p.status === '–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ');
        if(sz) filtered = filtered.filter(p => p.category === sz);
        if(se) filtered = filtered.filter(p => (p.season||'').includes(se));
        
        const box = document.getElementById('stock-list'); box.innerHTML = '';
        filtered.forEach(p => {
            box.innerHTML += `
                <div class="card">
                    <div class="card-header">${p.title}</div>
                    <div class="card-info">–ó–∞–ª–∏—à–æ–∫: ${p.tread_depth} | –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: ${p.specs}</div>
                    <div class="flex-row">
                        <input type="number" id="pr-${p.id}" class="price-edit" value="${p.price}">
                        <button class="btn btn-green" style="width:auto; padding:10px" onclick="updPrice('${p.id}')">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ —Ü—ñ–Ω—É</button>
                    </div>
                    <button class="btn btn-red" onclick="markSold('${p.id}', true)">üè∑ –í—ñ–¥–∑–Ω–∞—á–∏—Ç–∏ —è–∫ –ü–†–û–î–ê–ù–û (–û—Ñ–ª–∞–π–Ω)</button>
                </div>`;
        });
    }

    async function updPrice(id) {
        const newPr = document.getElementById(`pr-${id}`).value;
        await sb.from('products').update({ price: newPr }).eq('id', id);
        alert("–¶—ñ–Ω—É –æ–Ω–æ–≤–ª–µ–Ω–æ!"); loadData();
    }

    async function markSold(id, ask = true) {
        if(ask && !confirm("–í—ñ–¥–∑–Ω–∞—á–∏—Ç–∏ —è–∫ –ø—Ä–æ–¥–∞–Ω–æ? –§–æ—Ç–æ –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ –¥–ª—è –µ–∫–æ–Ω–æ–º—ñ—ó –º—ñ—Å—Ü—è, –∞–ª–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–±–µ—Ä–µ–∂–µ—Ç—å—Å—è.")) return;
        
        // –í–∏–¥–∞–ª—è—î–º–æ —Ñ–æ—Ç–æ –∑—ñ Storage, –∑–∞–ª–∏—à–∞—î–º–æ —Ç–µ–∫—Å—Ç –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        const p = allProducts.find(x => x.id === id);
        const delImg = async (url) => { if(url) await sb.storage.from('tyres').remove([url.split('/').pop()]); };
        await delImg(p.image_url_1); await delImg(p.image_url_2); await delImg(p.image_url_3); await delImg(p.image_url_4);
        
        await sb.from('products').update({ status: '–ü—Ä–æ–¥–∞–Ω–æ', image_url_1: null, image_url_2: null, image_url_3: null, image_url_4: null }).eq('id', id);
        loadData();
    }

    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    let chart1, chart2;
    function renderStats(orders) {
        const soldProds = allProducts.filter(p => p.status === '–ü—Ä–æ–¥–∞–Ω–æ');
        const activeProds = allProducts.filter(p => p.status === '–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ');
        
        let activeSum = 0; activeProds.forEach(p => activeSum += Number(p.price));
        let soldSum = 0; orders.filter(o => o.status === '–í–∏–∫–æ–Ω–∞–Ω–æ').forEach(o => soldSum += Number(o.price));
        soldProds.forEach(p => { if(!orders.find(o => o.product_id === p.id)) soldSum += Number(p.price); }); // –æ—Ñ–ª–∞–π–Ω –ø—Ä–æ–¥–∞–∂—ñ

        document.getElementById('stats-grid').innerHTML = `
            <div class="stat-box">–¢–æ–≤–∞—Ä—ñ–≤ —à—Ç.<b>${activeProds.length}</b></div>
            <div class="stat-box">–°—É–º–∞ —Å–∫–ª–∞–¥—É<b>${activeSum} –≥—Ä–Ω</b></div>
            <div class="stat-box" style="border-color:var(--olive)">–ü—Ä–æ–¥–∞–Ω–æ —à—Ç.<b>${soldProds.length}</b></div>
            <div class="stat-box" style="border-color:var(--olive)">–ó–∞—Ä–æ–±—ñ—Ç–æ–∫<b>${soldSum} –≥—Ä–Ω</b></div>
        `;

        // –ì—Ä–∞—Ñ—ñ–∫–∏
        const brands = {}; const sizes = {};
        soldProds.forEach(p => {
            brands[p.brand] = (brands[p.brand] || 0) + 1;
            sizes[p.category] = (sizes[p.category] || 0) + 1;
        });

        if(chart1) chart1.destroy(); if(chart2) chart2.destroy();
        
        chart1 = new Chart(document.getElementById('brandChart'), {
            type: 'pie',
            data: { labels: Object.keys(brands), datasets: [{ data: Object.values(brands), backgroundColor: ['#8fbc55','#556b2f','#444','#666','#888'] }] },
            options: { plugins: { title: { display: true, text: '–ü—Ä–æ–¥–∞–∂—ñ –∑–∞ –±—Ä–µ–Ω–¥–∞–º–∏', color: '#fff' }, legend: { labels: { color: '#bbb' } } } }
        });

        chart2 = new Chart(document.getElementById('sizeChart'), {
            type: 'bar',
            data: { labels: Object.keys(sizes), datasets: [{ label: '–ü—Ä–æ–¥–∞–Ω–æ —à—Ç.', data: Object.values(sizes), backgroundColor: '#8fbc55' }] },
            options: { plugins: { title: { display: true, text: '–ü—Ä–æ–¥–∞–∂—ñ –∑–∞ —Ä–æ–∑–º—ñ—Ä–∞–º–∏', color: '#fff' }, legend: { display: false } }, scales: { y: { ticks: { color: '#bbb' } }, x: { ticks: { color: '#bbb' } } } }
        });
    }

    loadData();
</script>
</body>
</html>
