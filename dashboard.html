<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è ‚Äî Tyre Shop</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="config.js"></script>
    <style>
        :root { --bg: #0a0c10; --panel: #14171c; --olive: #8fbc55; --text: #e5e7eb; --red: #ff4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; font-size: 14px;}
        
        .top-nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-link { flex: 1; background: #222; color: #fff; padding: 12px; border-radius: 10px; text-align: center; text-decoration: none; font-weight: bold; border: 1px solid #333; box-shadow: 0 4px 0 #111; }
        .nav-link:active { transform: translateY(2px); box-shadow: none; }
        
        .tabs { display: flex; border-bottom: 2px solid #333; margin-bottom: 20px; overflow-x: auto; white-space: nowrap; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; color: #888; }
        .tab.active { color: var(--olive); border-bottom: 3px solid var(--olive); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid #333; margin-bottom: 12px; position: relative; }
        .card-header { font-weight: bold; color: #fff; margin-bottom: 8px; font-size: 15px; line-height: 1.3; padding-right: 30px;}
        .card-info { font-size: 13px; color: #aaa; margin-bottom: 10px; line-height: 1.4; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;}
        .stat-box { background: #000; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #222; }
        .stat-box b { display: block; font-size: 20px; color: var(--olive); margin-top: 5px; }
        .chart-container { background: #000; border: 1px solid #222; border-radius: 10px; padding: 10px; margin-bottom: 15px; }
        
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; width: 100%; font-size: 13px; margin-top: 5px;}
        .btn-green { background: var(--olive); color: #000; }
        .btn-red { background: transparent; color: var(--red); border: 1px solid var(--red); }
        .btn-del-icon { position: absolute; top: 12px; right: 12px; background: transparent; color: var(--red); border: none; font-size: 18px; cursor: pointer; padding: 5px; }
        
        .filters { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        select { background: #000; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 8px; outline: none; flex: 1;}
        .price-edit { background: #000; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 8px; width: 80px; margin-right: 10px; font-weight: bold; }
        .flex-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;}
        
        /* –ß–µ–∫–±–æ–∫—Å–∏ –¥–ª—è –º–∞—Å–æ–≤–∏—Ö –¥—ñ–π */
        .chk-box { position: absolute; top: 15px; left: 15px; transform: scale(1.3); accent-color: var(--olive); }
        .card-with-chk { padding-left: 45px; }
        .bulk-bar { display: none; background: #222; padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--olive); align-items: center; justify-content: space-between; position: sticky; top: 10px; z-index: 10;}
    </style>
</head>
<body>

<div class="top-nav">
    <a href="index.html" class="nav-link">üè™ –ú–ê–ì–ê–ó–ò–ù</a>
    <a href="agent_tyre.html" class="nav-link">‚ûï –î–û–î–ê–¢–ò –¢–û–í–ê–†</a>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('orders', this)">üîî –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
    <div class="tab" onclick="switchTab('stock', this)">üì¶ –°–∫–ª–∞–¥</div>
    <div class="tab" onclick="switchTab('stats', this)">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
</div>

<div id="orders" class="tab-content active"><div id="orders-list">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>

<div id="stock" class="tab-content">
    <div class="bulk-bar" id="bulk-bar">
        <span id="sel-count" style="color:#fff; font-weight:bold;">–û–±—Ä–∞–Ω–æ: 0</span>
        <button class="btn btn-red" style="width:auto; padding:8px 15px; margin:0;" onclick="bulkDelete()">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>
    </div>

    <div class="filters">
        <select id="f-season" onchange="applyFilters()"><option value="">–í—Å—ñ —Å–µ–∑–æ–Ω–∏</option><option value="–ó–∏–º–∞">–ó–∏–º–∞</option><option value="–õ—ñ—Ç–æ">–õ—ñ—Ç–æ</option></select>
        <select id="f-size" onchange="applyFilters()"><option value="">–í—Å—ñ —Ä–æ–∑–º—ñ—Ä–∏</option></select>
        <select id="f-status" onchange="applyFilters()"><option value="–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ">–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</option><option value="–ü—Ä–æ–¥–∞–Ω–æ">–ü—Ä–æ–¥–∞–Ω—ñ</option><option value="">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option></select>
    </div>
    <div id="stock-list"></div>
</div>

<div id="stats" class="tab-content">
    <div class="filters">
        <select id="stat-period" onchange="loadData()">
            <option value="all">–ó–∞ –≤–µ—Å—å —á–∞—Å</option>
            <option value="30">–ó–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 30 –¥–Ω—ñ–≤</option>
            <option value="7">–ó–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤</option>
            <option value="1">–°—å–æ–≥–æ–¥–Ω—ñ</option>
        </select>
    </div>
    <div class="stat-grid" id="stats-grid"></div>
    <div class="chart-container"><canvas id="brandChart"></canvas></div>
    <div class="chart-container"><canvas id="sizeChart"></canvas></div>
</div>

<script>
    const sb = supabase.createClient(CONFIG.SB_URL, CONFIG.SB_KEY);
    let allProducts = [];
    let allOrders = [];

    function switchTab(id, el) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active'); el.classList.add('active');
    }

    async function loadData() {
        const [ordRes, prodRes] = await Promise.all([
            sb.from('orders').select('*').order('created_at', {ascending: false}),
            sb.from('products').select('*').order('created_at', {ascending: false})
        ]);
        allProducts = prodRes.data || [];
        allOrders = ordRes.data || [];
        
        renderOrders();
        populateFilters(); applyFilters();
        renderStats();
    }

    /* –ó–ê–ú–û–í–õ–ï–ù–ù–Ø */
    function renderOrders() {
        const box = document.getElementById('orders-list'); box.innerHTML = '';
        const active = allOrders.filter(o => o.status === '–ù–æ–≤–∏–π');
        if(active.length === 0) return box.innerHTML = '<div class="card" style="text-align:center; color:#888;">–ù–µ–º–∞—î –Ω–æ–≤–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å</div>';
        
        active.forEach(o => {
            box.innerHTML += `
                <div class="card">
                    <div class="card-header">üõí ${o.product_title}</div>
                    <div class="card-info">
                        <b>–ö–ª—ñ—î–Ω—Ç:</b> ${o.customer_name} (${o.customer_phone})<br>
                        <b>–î–æ—Å—Ç–∞–≤–∫–∞:</b> ${o.delivery} | <b>–û–ø–ª–∞—Ç–∞:</b> ${o.payment}<br>
                        üí∞ –°—É–º–∞: <b style="color:var(--olive); font-size:16px">${o.price} –≥—Ä–Ω</b>
                    </div>
                    <button class="btn btn-green" onclick="completeOrder('${o.id}', '${o.product_id}')">‚úÖ –í–ò–ö–û–ù–ê–ù–û (–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ –ø—Ä–æ–¥–∞–Ω—ñ)</button>
                </div>`;
        });
    }

    async function completeOrder(oId, pId) {
        if(!confirm("–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?")) return;
        await sb.from('orders').update({ status: '–í–∏–∫–æ–Ω–∞–Ω–æ' }).eq('id', oId);
        await markSold(pId, false); // –ü–µ—Ä–µ–≤–æ–¥–∏–º–æ —Ç–æ–≤–∞—Ä —É –ø—Ä–æ–¥–∞–Ω—ñ
    }

    /* –°–ö–õ–ê–î –¢–ê –§–Ü–õ–¨–¢–†–ò */
    function populateFilters() {
        const sizes = [...new Set(allProducts.map(p => p.category).filter(Boolean))];
        const szSelect = document.getElementById('f-size');
        const currVal = szSelect.value;
        szSelect.innerHTML = '<option value="">–í—Å—ñ —Ä–æ–∑–º—ñ—Ä–∏</option>';
        sizes.forEach(s => szSelect.innerHTML += `<option value="${s}">${s}</option>`);
        szSelect.value = currVal;
    }

    function applyFilters() {
        const sz = document.getElementById('f-size').value;
        const se = document.getElementById('f-season').value;
        const st = document.getElementById('f-status').value;
        
        let filtered = allProducts;
        if(st) filtered = filtered.filter(p => p.status === st);
        if(sz) filtered = filtered.filter(p => p.category === sz);
        if(se) filtered = filtered.filter(p => (p.season||'').includes(se));
        
        const box = document.getElementById('stock-list'); box.innerHTML = '';
        if(filtered.length === 0) return box.innerHTML = '<div class="card" style="text-align:center; color:#888;">–¢–æ–≤–∞—Ä—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';

        filtered.forEach(p => {
            const isSold = p.status === '–ü—Ä–æ–¥–∞–Ω–æ';
            box.innerHTML += `
                <div class="card card-with-chk" style="${isSold ? 'opacity:0.6; border-color:#222;' : ''}">
                    <input type="checkbox" class="chk-box item-chk" value="${p.id}" onchange="toggleBulk()">
                    <button class="btn-del-icon" onclick="deleteSingle('${p.id}')">üóë</button>
                    
                    <div class="card-header">${p.title}</div>
                    <div class="card-info">
                        –ó–∞–ª–∏—à–æ–∫: ${p.tread_depth || '-'} <br>
                        –°—Ç–∞—Ç—É—Å: <b style="color:${isSold ? '#888' : 'var(--olive)'}">${p.status}</b>
                    </div>
                    
                    ${!isSold ? `
                    <div class="flex-row">
                        <input type="number" id="pr-${p.id}" class="price-edit" value="${p.price}">
                        <button class="btn btn-green" style="width:auto; padding:10px" onclick="updPrice('${p.id}')">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ —Ü—ñ–Ω—É</button>
                    </div>
                    <button class="btn btn-red" style="color:#aaa; border-color:#444" onclick="markSold('${p.id}', true)">üè∑ –í—ñ–¥–∑–Ω–∞—á–∏—Ç–∏ —è–∫ –ü–†–û–î–ê–ù–û (–û—Ñ–ª–∞–π–Ω)</button>
                    ` : ''}
                </div>`;
        });
        toggleBulk();
    }

    /* –ú–ê–°–û–í–Ü –î–Ü–á –¢–ê –í–ò–î–ê–õ–ï–ù–ù–Ø */
    function toggleBulk() {
        const chks = document.querySelectorAll('.item-chk:checked');
        const bar = document.getElementById('bulk-bar');
        document.getElementById('sel-count').innerText = `–û–±—Ä–∞–Ω–æ: ${chks.length}`;
        bar.style.display = chks.length > 0 ? 'flex' : 'none';
    }

    async function deleteSingle(id) {
        if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ç–æ–≤–∞—Ä –Ω–∞–∑–∞–≤–∂–¥–∏?")) return;
        await deleteLogic([id]);
    }

    async function bulkDelete() {
        const chks = document.querySelectorAll('.item-chk:checked');
        if(!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –æ–±—Ä–∞–Ω—ñ —Ç–æ–≤–∞—Ä–∏ (${chks.length} —à—Ç.) –Ω–∞–∑–∞–≤–∂–¥–∏?`)) return;
        const ids = Array.from(chks).map(c => c.value);
        await deleteLogic(ids);
    }

    async function deleteLogic(ids) {
        const toDelete = allProducts.filter(p => ids.includes(p.id));
        
        // –í–∏–¥–∞–ª–µ–Ω–Ω—è —Ñ–æ—Ç–æ –∑ Storage
        for(let p of toDelete) {
            const delImg = async (url) => { if(url) await sb.storage.from('tyres').remove([url.split('/').pop()]); };
            await delImg(p.image_url_1); await delImg(p.image_url_2); await delImg(p.image_url_3); await delImg(p.image_url_4);
        }
        
        await sb.from('products').delete().in('id', ids);
        loadData();
    }

    async function markSold(id, ask = true) {
        if(ask && !confirm("–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ –ø—Ä–æ–¥–∞–Ω—ñ? –§–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ, –∞–ª–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–±–µ—Ä–µ–∂–µ—Ç—å—Å—è.")) return;
        
        const p = allProducts.find(x => x.id === id);
        const delImg = async (url) => { if(url) await sb.storage.from('tyres').remove([url.split('/').pop()]); };
        await delImg(p.image_url_1); await delImg(p.image_url_2); await delImg(p.image_url_3); await delImg(p.image_url_4);
        
        await sb.from('products').update({ status: '–ü—Ä–æ–¥–∞–Ω–æ', image_url_1: null, image_url_2: null, image_url_3: null, image_url_4: null }).eq('id', id);
        loadData();
    }

    async function updPrice(id) {
        const newPr = document.getElementById(`pr-${id}`).value;
        await sb.from('products').update({ price: newPr }).eq('id', id);
        alert("–¶—ñ–Ω—É –æ–Ω–æ–≤–ª–µ–Ω–æ!"); loadData();
    }

    /* –°–¢–ê–¢–ò–°–¢–ò–ö–ê */
    let chart1, chart2;
    function renderStats() {
        const period = document.getElementById('stat-period').value;
        const now = new Date();
        let limitDate = new Date(0); // 1970
        if(period !== 'all') { limitDate = new Date(now.setDate(now.getDate() - parseInt(period))); }

        // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –∑–∞ –¥–∞—Ç–æ—é
        const prods = allProducts.filter(p => new Date(p.created_at) >= limitDate);
        const ords = allOrders.filter(o => new Date(o.created_at) >= limitDate);

        const soldProds = prods.filter(p => p.status === '–ü—Ä–æ–¥–∞–Ω–æ');
        const activeProds = prods.filter(p => p.status === '–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ');
        
        let activeSum = 0; activeProds.forEach(p => activeSum += Number(p.price));
        let soldSum = 0; ords.filter(o => o.status === '–í–∏–∫–æ–Ω–∞–Ω–æ').forEach(o => soldSum += Number(o.price));
        
        // –î–æ–¥–∞—î–º–æ –æ—Ñ–ª–∞–π–Ω –ø—Ä–æ–¥–∞–∂—ñ (—Ç–æ–≤–∞—Ä–∏ –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º –ü—Ä–æ–¥–∞–Ω–æ, —è–∫–∏—Ö –Ω–µ–º–∞—î –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è—Ö)
        soldProds.forEach(p => { if(!ords.find(o => o.product_id === p.id)) soldSum += Number(p.price); });

        document.getElementById('stats-grid').innerHTML = `
            <div class="stat-box">–ù–∞ —Å–∫–ª–∞–¥—ñ —à—Ç.<b>${activeProds.length}</b></div>
            <div class="stat-box">–°—É–º–∞ —Å–∫–ª–∞–¥—É<b>${activeSum} –≥—Ä–Ω</b></div>
            <div class="stat-box" style="border-color:var(--olive)">–ü—Ä–æ–¥–∞–Ω–æ —à—Ç.<b>${soldProds.length}</b></div>
            <div class="stat-box" style="border-color:var(--olive)">–ü—Ä–æ–¥–∞–∂—ñ –Ω–∞ —Å—É–º—É<b>${soldSum} –≥—Ä–Ω</b></div>
        `;

        // –ì—Ä–∞—Ñ—ñ–∫–∏
        const brands = {}; const sizes = {};
        soldProds.forEach(p => {
            brands[p.brand || '–ù–µ–≤—ñ–¥–æ–º–æ'] = (brands[p.brand || '–ù–µ–≤—ñ–¥–æ–º–æ'] || 0) + 1;
            sizes[p.category || '–Ü–Ω—à–µ'] = (sizes[p.category || '–Ü–Ω—à–µ'] || 0) + 1;
        });

        if(chart1) chart1.destroy(); if(chart2) chart2.destroy();
        
        chart1 = new Chart(document.getElementById('brandChart'), {
            type: 'pie',
            data: { labels: Object.keys(brands), datasets: [{ data: Object.values(brands), backgroundColor: ['#8fbc55','#556b2f','#444','#666','#888'] }] },
            options: { plugins: { title: { display: true, text: '–ü—Ä–æ–¥–∞–∂—ñ –∑–∞ –±—Ä–µ–Ω–¥–∞–º–∏', color: '#fff' }, legend: { labels: { color: '#bbb' } } } }
        });

        // –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –¥–ª—è –¥—Ä–æ–±–æ–≤–∏—Ö —á–∏—Å–µ–ª –Ω–∞ –≥—Ä–∞—Ñ—ñ–∫—É —Ä–æ–∑–º—ñ—Ä—ñ–≤
        chart2 = new Chart(document.getElementById('sizeChart'), {
            type: 'bar',
            data: { labels: Object.keys(sizes), datasets: [{ label: '–ü—Ä–æ–¥–∞–Ω–æ —à—Ç.', data: Object.values(sizes), backgroundColor: '#8fbc55' }] },
            options: { 
                plugins: { title: { display: true, text: '–ü—Ä–æ–¥–∞–∂—ñ –∑–∞ —Ä–æ–∑–º—ñ—Ä–∞–º–∏', color: '#fff' }, legend: { display: false } }, 
                scales: { 
                    y: { ticks: { color: '#bbb', stepSize: 1, precision: 0 } }, // –¢—ñ–ª—å–∫–∏ —Ü—ñ–ª—ñ —á–∏—Å–ª–∞
                    x: { ticks: { color: '#bbb' } } 
                } 
            }
        });
    }
</script>
</body>
</html>
