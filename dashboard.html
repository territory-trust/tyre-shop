<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è ‚Äî Tyre Shop</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="config.js"></script>
    <style>
        :root { --bg: #0a0c10; --panel: #14171c; --olive: #8fbc55; --text: #e5e7eb; --red: #ff4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; font-size: 14px;}
        
        .top-nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-link { flex: 1; background: #222; color: #fff; padding: 12px; border-radius: 10px; text-align: center; text-decoration: none; font-weight: bold; border: 1px solid #333; box-shadow: 0 4px 0 #111; }
        .nav-link:active { transform: translateY(2px); box-shadow: none; }
        
        .tabs { display: flex; border-bottom: 2px solid #333; margin-bottom: 20px; overflow-x: auto; white-space: nowrap; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; color: #888; transition: 0.3s;}
        .tab.active { color: var(--olive); border-bottom: 3px solid var(--olive); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card { background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid #333; margin-bottom: 12px; position: relative; }
        .card-header { font-weight: bold; color: #fff; margin-bottom: 8px; font-size: 15px; line-height: 1.3; padding-right: 30px;}
        .card-info { font-size: 13px; color: #aaa; margin-bottom: 10px; line-height: 1.4; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;}
        .stat-box { background: #000; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #222; }
        .stat-box b { display: block; font-size: 20px; color: var(--olive); margin-top: 5px; }
        .chart-container { background: #000; border: 1px solid #222; border-radius: 10px; padding: 10px; margin-bottom: 15px; }
        
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; width: 100%; font-size: 13px; margin-top: 5px; transition: 0.2s;}
        .btn:active { transform: translateY(2px); }
        .btn-green { background: var(--olive); color: #000; }
        
        .btn-red { background: rgba(255, 68, 68, 0.15); color: var(--red); border: none; }
        .btn-outline-green { background: transparent; color: var(--olive); border: 1px solid var(--olive); }
        
        .btn-del-icon { position: absolute; top: 12px; right: 12px; background: transparent; color: var(--red); border: none; font-size: 18px; cursor: pointer; padding: 5px; }
        
        .filters { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        select { background: #1b1e24; color: #fff; border: none; padding: 10px; border-radius: 8px; outline: none; flex: 1; font-weight: 500;}
        
        .price-edit { background: #000; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 8px; width: 80px; margin-right: 10px; font-weight: bold; }
        .flex-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;}
        
        .chk-box { position: absolute; top: 15px; left: 15px; transform: scale(1.3); accent-color: var(--olive); cursor: pointer;}
        .card-with-chk { padding-left: 45px; }
        .bulk-bar { display: none; background: #222; padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--olive); align-items: center; justify-content: space-between; position: sticky; top: 10px; z-index: 10;}
    </style>
</head>
<body>

<div class="top-nav">
    <a href="index.html" class="nav-link">üè™ –ú–ê–ì–ê–ó–ò–ù</a>
    <a href="agent_tyre.html" class="nav-link">‚ûï –î–û–î–ê–¢–ò –¢–û–í–ê–†</a>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('orders', this)">üîî –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
    <div class="tab" onclick="switchTab('stock', this)">üì¶ –°–∫–ª–∞–¥</div>
    <div class="tab" onclick="switchTab('stats', this)">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
</div>

<div id="orders" class="tab-content active">
    <button class="btn btn-outline-green" style="margin-bottom: 15px;" onclick="fetchData()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –∑–∞–º–æ–≤–ª–µ–Ω—å</button>
    <div id="orders-list"><div style="text-align:center; padding:20px; color:#888;">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>
</div>

<div id="stock" class="tab-content">
    <div class="bulk-bar" id="bulk-bar">
        <span id="sel-count" style="color:#fff; font-weight:bold;">–û–±—Ä–∞–Ω–æ: 0</span>
        <button class="btn btn-red" style="width:auto; padding:8px 15px; margin:0;" onclick="bulkDelete()">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>
    </div>

    <div class="filters">
        <select id="f-season" onchange="applyFilters()"><option value="">–í—Å—ñ —Å–µ–∑–æ–Ω–∏</option><option value="–ó–∏–º–∞">–ó–∏–º–∞</option><option value="–õ—ñ—Ç–æ">–õ—ñ—Ç–æ</option></select>
        <select id="f-size" onchange="applyFilters()"><option value="">–í—Å—ñ —Ä–æ–∑–º—ñ—Ä–∏</option></select>
        <select id="f-status" onchange="applyFilters()"><option value="–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ">–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</option><option value="–ü—Ä–æ–¥–∞–Ω–æ">–ü—Ä–æ–¥–∞–Ω—ñ</option><option value="">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option></select>
    </div>
    <div id="stock-list"><div style="text-align:center; padding:20px; color:#888;">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∫–ª–∞–¥—É...</div></div>
</div>

<div id="stats" class="tab-content">
    <div class="filters">
        <select id="stat-period" onchange="renderStats()">
            <option value="all">–ó–∞ –≤–µ—Å—å —á–∞—Å</option>
            <option value="30">–ó–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 30 –¥–Ω—ñ–≤</option>
            <option value="7">–ó–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤</option>
            <option value="1">–°—å–æ–≥–æ–¥–Ω—ñ</option>
        </select>
    </div>
    <div class="stat-grid" id="stats-grid"></div>
    <div class="chart-container"><canvas id="brandChart"></canvas></div>
    <div class="chart-container"><canvas id="sizeChart"></canvas></div>
</div>

<script>
    const sb = supabase.createClient(CONFIG.SB_URL, CONFIG.SB_KEY);
    let allProducts = [];
    let allOrders = [];

    window.onload = () => { fetchData(); };

    function switchTab(id, el) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active'); 
        el.classList.add('active');
    }

    async function fetchData() {
        const ordBox = document.getElementById('orders-list');
        if(ordBox.innerHTML.includes('–ù–µ–º–∞—î –Ω–æ–≤–∏—Ö')) ordBox.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">‚è≥ –û–Ω–æ–≤–ª–µ–Ω–Ω—è...</div>';

        const [ordRes, prodRes] = await Promise.all([
            sb.from('orders').select('*').order('created_at', {ascending: false}),
            sb.from('products').select('*').order('created_at', {ascending: false})
        ]);
        allProducts = prodRes.data || [];
        allOrders = ordRes.data || [];
        
        renderOrders();
        populateFilters(); 
        applyFilters();
        renderStats();
    }

    function renderOrders() {
        const box = document.getElementById('orders-list'); box.innerHTML = '';
        const active = allOrders.filter(o => o.status === '–ù–æ–≤–∏–π');
        if(active.length === 0) return box.innerHTML = '<div class="card" style="text-align:center; color:#888;">–ù–µ–º–∞—î –Ω–æ–≤–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å</div>';
        
        active.forEach(o => {
            const cleanPhone = (o.customer_phone || '').replace(/\D/g, '');
            const isCard = (o.payment || '').includes('–∫–∞—Ä—Ç–∫—É');
            const savedCard = localStorage.getItem('my_saved_card') || '';
            
            // –§–æ—Ä–º—É—î–º–æ –±–ª–æ–∫ –¥–ª—è –æ–ø–ª–∞—Ç–∏ –∫–∞—Ä—Ç–∫–æ—é (–∑'—è–≤–ª—è—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –∑–∞ –ø–æ—Ç—Ä–µ–±–∏)
            let cardBlock = '';
            if (isCard) {
                cardBlock = `
                <div style="display:flex; align-items:center; gap:8px; margin-top:10px; background:#1b1e24; padding:10px; border-radius:8px; border:1px dashed var(--olive);">
                    <span style="font-size:20px;">üí≥</span>
                    <input type="text" id="card-${o.id}" placeholder="–í–∞—à–∞ –∫–∞—Ä—Ç–∫–∞" value="${savedCard}" style="background:#000; color:#fff; border:1px solid #444; padding:8px; border-radius:6px; flex:1; font-size:14px; outline:none; font-weight:bold;" oninput="localStorage.setItem('my_saved_card', this.value)">
                    <button class="btn-green" style="padding:8px 12px; margin:0; width:auto; font-size:12px; border-radius:6px;" onclick="sendCardTg('${o.id}', 'card-${o.id}')">‚úàÔ∏è –£ Telegram</button>
                </div>`;
            }

            box.innerHTML += `
                <div class="card">
                    <div class="card-header">üõí ${o.product_title}</div>
                    <div class="card-info">
                        <b>–ö–ª—ñ—î–Ω—Ç:</b> ${o.customer_name} <br>
                        
                        <div style="display:flex; align-items:center; gap:10px; margin: 8px 0;">
                            <b style="font-size:16px; color:#fff;">${o.customer_phone}</b>
                            <a href="tel:${cleanPhone}" class="btn-outline-green" style="padding:6px 12px; text-decoration:none; border-radius:8px; font-weight:bold; font-size:13px; display:inline-block;">üìû –ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏</a>
                        </div>
                        
                        <b>–î–æ—Å—Ç–∞–≤–∫–∞:</b> ${o.delivery} <br>
                        <b>–û–ø–ª–∞—Ç–∞:</b> <span style="color:${isCard ? 'var(--olive)' : '#aaa'}">${o.payment}</span><br>
                        üí∞ –°—É–º–∞: <b style="color:var(--olive); font-size:16px">${o.price} –≥—Ä–Ω</b>
                        
                        ${cardBlock}
                    </div>
                    <button class="btn btn-green" onclick="completeOrder('${o.id}', '${o.product_id}')">‚úÖ –í–ò–ö–û–ù–ê–ù–û (–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ –ø—Ä–æ–¥–∞–Ω—ñ)</button>
                </div>`;
        });
    }

    // –§—É–Ω–∫—Ü—ñ—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Ä–µ–∫–≤—ñ–∑–∏—Ç—ñ–≤ —É –¢–µ–ª–µ–≥—Ä–∞–º
    window.sendCardTg = function(orderId, inputId) {
        const o = allOrders.find(x => x.id === orderId);
        const card = document.getElementById(inputId).value;
        if(!card) return alert("–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏!");
        
        let tgPhone = (o.customer_phone || '').replace(/\D/g, '');
        if(tgPhone.startsWith('0')) tgPhone = '38' + tgPhone;
        if(!tgPhone.startsWith('+')) tgPhone = '+' + tgPhone;
        
        const msg = `–î–æ–±—Ä–æ–≥–æ –¥–Ω—è! –í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: ${o.product_title}.\n–î–æ —Å–ø–ª–∞—Ç–∏: ${o.price} –≥—Ä–Ω.\nüí≥ –†–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –æ–ø–ª–∞—Ç–∏: ${card}`;
        const url = `https://t.me/${tgPhone}?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank');
    }

    async function completeOrder(oId, pId) {
        if(!confirm("–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?")) return;
        await sb.from('orders').update({ status: '–í–∏–∫–æ–Ω–∞–Ω–æ' }).eq('id', oId);
        await markSold(pId, false); 
    }

    function populateFilters() {
        const sizes = [...new Set(allProducts.map(p => p.category).filter(Boolean))];
        const szSelect = document.getElementById('f-size');
        const currVal = szSelect.value;
        szSelect.innerHTML = '<option value="">–í—Å—ñ —Ä–æ–∑–º—ñ—Ä–∏</option>';
        sizes.forEach(s => szSelect.innerHTML += `<option value="${s}">${s}</option>`);
        szSelect.value = currVal;
    }

    function applyFilters() {
        const sz = document.getElementById('f-size').value;
        const se = document.getElementById('f-season').value;
        const st = document.getElementById('f-status').value;
        
        let filtered = allProducts;
        if(st) filtered = filtered.filter(p => p.status === st);
        if(sz) filtered = filtered.filter(p => p.category === sz);
        
        if(se) {
            const term = se === '–ó–∏–º–∞' ? '–∑–∏–º' : '–ª—ñ—Ç';
            filtered = filtered.filter(p => (p.season || '').toLowerCase().includes(term));
        }
        
        const box = document.getElementById('stock-list'); box.innerHTML = '';
        if(filtered.length === 0) return box.innerHTML = '<div class="card" style="text-align:center; color:#888;">–¢–æ–≤–∞—Ä—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';

        filtered.forEach(p => {
            const isSold = p.status === '–ü—Ä–æ–¥–∞–Ω–æ';
            box.innerHTML += `
                <div class="card card-with-chk" style="${isSold ? 'opacity:0.6; border-color:#222;' : ''}">
                    <input type="checkbox" class="chk-box item-chk" value="${p.id}" onchange="toggleBulk()">
                    <button class="btn-del-icon" onclick="deleteSingle('${p.id}')">üóë</button>
                    
                    <div class="card-header">${p.title}</div>
                    
                    <div class="card-info">
                        –°—Ç–∞—Ç—É—Å: <b style="color:${isSold ? '#888' : 'var(--olive)'}">${p.status}</b>
                    </div>
                    
                    ${!isSold ? `
                    <div class="flex-row">
                        <input type="number" id="pr-${p.id}" class="price-edit" value="${p.price}">
                        <button class="btn btn-green" style="width:auto; padding:10px" onclick="updPrice('${p.id}')">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ —Ü—ñ–Ω—É</button>
                    </div>
                    <button class="btn btn-outline-green" onclick="markSold('${p.id}', true)">üè∑ –ü—Ä–æ–¥–∞–Ω–æ –æ—Ñ–ª–∞–π–Ω</button>
                    ` : ''}
                </div>`;
        });
        toggleBulk();
    }

    function toggleBulk() {
        const chks = document.querySelectorAll('.item-chk:checked');
        const bar = document.getElementById('bulk-bar');
        document.getElementById('sel-count').innerText = `–û–±—Ä–∞–Ω–æ: ${chks.length}`;
        bar.style.display = chks.length > 0 ? 'flex' : 'none';
    }

    async function deleteSingle(id) {
        if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ç–æ–≤–∞—Ä –Ω–∞–∑–∞–≤–∂–¥–∏?")) return;
        await deleteLogic([id]);
    }

    async function bulkDelete() {
        const chks = document.querySelectorAll('.item-chk:checked');
        if(!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –æ–±—Ä–∞–Ω—ñ —Ç–æ–≤–∞—Ä–∏ (${chks.length} —à—Ç.) –Ω–∞–∑–∞–≤–∂–¥–∏?`)) return;
        const ids = Array.from(chks).map(c => c.value);
        await deleteLogic(ids);
    }

    async function deleteLogic(ids) {
        const toDelete = allProducts.filter(p => ids.includes(p.id));
        for(let p of toDelete) {
            const delImg = async (url) => { if(url) await sb.storage.from('tyres').remove([url.split('/').pop()]); };
            await delImg(p.image_url_1); await delImg(p.image_url_2); await delImg(p.image_url_3); await delImg(p.image_url_4);
        }
        await sb.from('products').delete().in('id', ids);
        fetchData(); 
    }

    async function markSold(id, ask = true) {
        if(ask && !confirm("–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ –ø—Ä–æ–¥–∞–Ω—ñ? –§–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ, –∞–ª–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–±–µ—Ä–µ–∂–µ—Ç—å—Å—è.")) return;
        const p = allProducts.find(x => x.id === id);
        const delImg = async (url) => { if(url) await sb.storage.from('tyres').remove([url.split('/').pop()]); };
        await delImg(p.image_url_1); await delImg(p.image_url_2); await delImg(p.image_url_3); await delImg(p.image_url_4);
        await sb.from('products').update({ status: '–ü—Ä–æ–¥–∞–Ω–æ', image_url_1: null, image_url_2: null, image_url_3: null, image_url_4: null }).eq('id', id);
        fetchData();
    }

    async function updPrice(id) {
        const newPr = document.getElementById(`pr-${id}`).value;
        await sb.from('products').update({ price: newPr }).eq('id', id);
        alert("–¶—ñ–Ω—É –æ–Ω–æ–≤–ª–µ–Ω–æ!"); fetchData();
    }

    function getQty(str) {
        if (!str) return 1;
        const s = str.toLowerCase();
        if (s.includes('–ø–∞—Ä–∞') || s.includes('2 —à—Ç')) return 2;
        if (s.includes('–∫–æ–º–ø–ª–µ–∫—Ç') || s.includes('4 —à—Ç')) return 4;
        const match = str.match(/\d+/);
        return match ? parseInt(match[0]) : 1;
    }

    let chart1, chart2;
    function renderStats() {
        const period = document.getElementById('stat-period').value;
        
        let limitDate = new Date(0);
        if (period === '1') {
            limitDate = new Date();
            limitDate.setHours(0, 0, 0, 0); 
        } else if (period !== 'all') {
            limitDate = new Date();
            limitDate.setDate(limitDate.getDate() - parseInt(period));
            limitDate.setHours(0, 0, 0, 0);
        }

        const prods = allProducts.filter(p => new Date(p.created_at) >= limitDate);
        const ords = allOrders.filter(o => new Date(o.created_at) >= limitDate);

        const soldProds = prods.filter(p => p.status === '–ü—Ä–æ–¥–∞–Ω–æ');
        const activeProds = prods.filter(p => p.status === '–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ');
        
        let activeSum = 0; 
        let activeTiresCount = 0;
        activeProds.forEach(p => { 
            activeSum += Number(p.price); 
            activeTiresCount += getQty(p.quantity); 
        });

        let soldSum = 0; 
        let soldTiresCount = 0;
        
        ords.filter(o => o.status === '–í–∏–∫–æ–Ω–∞–Ω–æ').forEach(o => soldSum += Number(o.price));
        
        soldProds.forEach(p => { 
            soldTiresCount += getQty(p.quantity);
            if(!ords.find(o => o.product_id === p.id)) soldSum += Number(p.price); 
        });

        document.getElementById('stats-grid').innerHTML = `
            <div class="stat-box">–ù–∞ —Å–∫–ª–∞–¥—ñ —à—Ç.<b>${activeTiresCount}</b></div>
            <div class="stat-box">–°—É–º–∞ —Å–∫–ª–∞–¥—É<b>${activeSum} –≥—Ä–Ω</b></div>
            <div class="stat-box" style="border-color:var(--olive)">–ü—Ä–æ–¥–∞–Ω–æ —à—Ç.<b>${soldTiresCount}</b></div>
            <div class="stat-box" style="border-color:var(--olive)">–ü—Ä–æ–¥–∞–∂—ñ –Ω–∞ —Å—É–º—É<b>${soldSum} –≥—Ä–Ω</b></div>
        `;

        const brands = {}; const sizes = {};
        soldProds.forEach(p => {
            const q = getQty(p.quantity);
            brands[p.brand || '–ù–µ–≤—ñ–¥–æ–º–æ'] = (brands[p.brand || '–ù–µ–≤—ñ–¥–æ–º–æ'] || 0) + q;
            sizes[p.category || '–Ü–Ω—à–µ'] = (sizes[p.category || '–Ü–Ω—à–µ'] || 0) + q;
        });

        if(chart1) chart1.destroy(); if(chart2) chart2.destroy();
        
        chart1 = new Chart(document.getElementById('brandChart'), {
            type: 'pie',
            data: { labels: Object.keys(brands), datasets: [{ data: Object.values(brands), backgroundColor: ['#8fbc55','#556b2f','#444','#666','#888'] }] },
            options: { plugins: { title: { display: true, text: '–ü—Ä–æ–¥–∞–∂—ñ –∑–∞ –±—Ä–µ–Ω–¥–∞–º–∏', color: '#fff' }, legend: { labels: { color: '#bbb' } } } }
        });

        chart2 = new Chart(document.getElementById('sizeChart'), {
            type: 'bar',
            data: { labels: Object.keys(sizes), datasets: [{ label: '–ü—Ä–æ–¥–∞–Ω–æ —à—Ç.', data: Object.values(sizes), backgroundColor: '#8fbc55' }] },
            options: { 
                plugins: { title: { display: true, text: '–ü—Ä–æ–¥–∞–∂—ñ –∑–∞ —Ä–æ–∑–º—ñ—Ä–∞–º–∏', color: '#fff' }, legend: { display: false } }, 
                scales: { y: { ticks: { color: '#bbb', stepSize: 1, precision: 0 } }, x: { ticks: { color: '#bbb' } } } 
            }
        });
    }
</script>
</body>
</html>
